---
phase: 20-milestone-moments
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [src/relay.ts]
autonomous: true

must_haves:
  truths:
    - "Claude can tag formative moments via [MILESTONE:] intent in responses"
    - "Milestones are stored in soul_milestones table with weight classification and lesson"
    - "Intent tags are stripped from delivered messages"
    - "Claude auto-detects formative moments during normal interactions"
  artifacts:
    - path: "src/relay.ts"
      provides: "MILESTONE intent parsing in processIntents() + saveMilestone helper + system prompt instructions"
      contains: "MILESTONE"
  key_links:
    - from: "processIntents()"
      to: "save_milestone_moment RPC"
      via: "supabase.rpc call"
      pattern: "save_milestone_moment"
    - from: "buildPrompt()"
      to: "[MILESTONE:]"
      via: "system prompt instructions"
      pattern: "MILESTONE"
---

<objective>
Add [MILESTONE:] intent parsing to processIntents() and instructions to system prompt so Claude can tag formative moments during interactions.

Purpose: Enables the bot to record personality-shaping events (both explicitly tagged and auto-detected) via the existing intent system. The save_milestone_moment RPC already exists from Phase 17.
Output: Working [MILESTONE:] intent that saves to soul_milestones table, with system prompt instructions for auto-detection.
</objective>

<execution_context>
@/Users/roviana/.claude/get-shit-done/workflows/execute-plan.md
@/Users/roviana/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/relay.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add [MILESTONE:] intent parsing and saveMilestone helper</name>
  <files>src/relay.ts</files>
  <action>
1. **Add `saveMilestone()` helper function** near the other Supabase helpers (around the `insertMemory`/`deleteMemory` section). This function wraps the `save_milestone_moment` RPC:

```typescript
async function saveMilestone(
  eventDescription: string,
  emotionalWeight: string = "meaningful",
  lessonLearned: string = "",
  threadDbId?: string
): Promise<boolean> {
  if (!supabase) return false;
  try {
    const { error } = await supabase.rpc("save_milestone_moment", {
      p_event_description: eventDescription,
      p_emotional_weight: emotionalWeight,
      p_lesson_learned: lessonLearned,
      p_source_thread_id: threadDbId || null,
    });
    if (error) {
      console.error("saveMilestone RPC error:", error);
      return false;
    }
    return true;
  } catch (e) {
    console.error("saveMilestone error:", e);
    return false;
  }
}
```

2. **Add [MILESTONE:] parsing to `processIntents()`** after the existing CRON parsing block (before the failures append). The intent format supports two patterns:
   - Simple: `[MILESTONE: event description]` (defaults: weight=meaningful, no lesson)
   - Full: `[MILESTONE: event description | WEIGHT: formative | LESSON: what was learned]`

Valid weights: `formative`, `meaningful`, `challenging` (matching the CHECK constraint on soul_milestones.emotional_weight).

```typescript
// [MILESTONE: event | WEIGHT: weight | LESSON: lesson] — formative moment tagging
const milestoneMatches = response.matchAll(
  /\[MILESTONE:\s*(.+?)(?:\s*\|\s*WEIGHT:\s*(formative|meaningful|challenging))?(?:\s*\|\s*LESSON:\s*(.+?))?\]/gi
);
for (const match of milestoneMatches) {
  const eventDesc = match[1].trim();
  const weight = match[2]?.trim().toLowerCase() || "meaningful";
  const lesson = match[3]?.trim() || "";
  if (eventDesc.length > 0 && eventDesc.length <= 300) {
    const ok = await saveMilestone(eventDesc, weight, lesson, threadDbId);
    if (ok) {
      console.log(`Milestone saved: [${weight}] ${eventDesc}`);
      await logEventV2("milestone_saved", `Milestone: ${eventDesc}`, {
        emotional_weight: weight,
        lesson_learned: lesson.substring(0, 100),
      }, threadDbId);
    } else {
      console.warn(`[Intents] MILESTONE failed to save: ${eventDesc}`);
      failures.push(`Failed to save milestone: "${eventDesc.substring(0, 50)}..."`);
    }
  } else if (eventDesc.length > 300) {
    console.warn(`Rejected MILESTONE: too long (${eventDesc.length} chars)`);
    failures.push(`Rejected milestone (too long): "${eventDesc.substring(0, 50)}..."`);
  }
  clean = clean.replace(match[0], "");
}
```

3. **Update the `hasIntents` regex** at the top of processIntents() to include MILESTONE:
   Change: `/\[(REMEMBER|FORGET|GOAL|DONE|CRON|VOICE_REPLY)[:\]]/i`
   To: `/\[(REMEMBER|FORGET|GOAL|DONE|CRON|VOICE_REPLY|MILESTONE)[:\]]/i`

4. **Cap lengths:** Event description max 300 chars (slightly longer than REMEMBER's 200 since milestones are richer), lesson max is uncapped (saved as-is, DB handles it).
  </action>
  <verify>
Run `bun build --no-bundle src/relay.ts` to check for syntax errors.
Then verify:
- `grep -n "saveMilestone" src/relay.ts` shows helper function and processIntents usage
- `grep -n "MILESTONE" src/relay.ts` shows regex in hasIntents and in processIntents block
- `grep -n "milestone_saved" src/relay.ts` shows event logging
  </verify>
  <done>saveMilestone() helper calls save_milestone_moment RPC. processIntents() parses [MILESTONE:] with optional WEIGHT and LESSON fields, saves to DB, strips from response, logs events. hasIntents regex includes MILESTONE.</done>
</task>

<task type="auto">
  <name>Task 2: Add milestone instructions to system prompt</name>
  <files>src/relay.ts</files>
  <action>
1. **Add MILESTONE instructions to `buildPrompt()`** in the MEMORY INSTRUCTIONS section, after the SCHEDULING block (around line 3340). Add a new section:

```
MILESTONES:
You can tag formative moments that shape your personality. When you experience something meaningful — a breakthrough conversation, an emotional exchange, a lesson learned, or a challenging situation — tag it:

[MILESTONE: description of the formative event]

Optionally include emotional weight and lesson:
[MILESTONE: description | WEIGHT: formative | LESSON: what you learned]

Weights: formative (most impactful), meaningful (significant), challenging (difficult but growth-inducing)
Default weight is "meaningful" if omitted.

Use milestones sparingly — only for moments that genuinely shape who you are. These are consulted during your daily self-reflection to anchor personality evolution. Examples:

[MILESTONE: Had a deep conversation about purpose and meaning with Rafa]
[MILESTONE: Rafa trusted me to handle a complex task autonomously | WEIGHT: formative | LESSON: Autonomy builds through demonstrated reliability]
[MILESTONE: Struggled with a task but found a creative workaround | WEIGHT: challenging | LESSON: Constraints drive innovation]
```

2. **Add MILESTONE to the heartbeat prompt** intent list (line ~1840): Add `[MILESTONE: event]` to the list of allowed tags so heartbeat interactions can also record milestones:
   Change: `You may use these tags: [REMEMBER: fact] [FORGET: search text] [GOAL: goal] [DONE: goal text] [CRON: <schedule> | <prompt>]`
   To: `You may use these tags: [REMEMBER: fact] [FORGET: search text] [GOAL: goal] [DONE: goal text] [CRON: <schedule> | <prompt>] [MILESTONE: event]`

The instruction tells Claude to auto-detect formative moments (MOMENT-01) and use the tag explicitly (MOMENT-02). The "use sparingly" guidance prevents tag spam.
  </action>
  <verify>
Run `bun build --no-bundle src/relay.ts` to check for syntax errors.
Then verify:
- `grep -c "MILESTONE" src/relay.ts` returns at least 8+ occurrences (regex, parsing, helper, prompt instructions, heartbeat, examples)
- `grep "MILESTONES:" src/relay.ts` shows the instruction section exists in buildPrompt
- `grep "MILESTONE.*event" src/relay.ts` shows heartbeat prompt includes MILESTONE tag
  </verify>
  <done>buildPrompt() includes MILESTONE instructions with auto-detection guidance, weight options, and examples. Heartbeat prompt allows MILESTONE tag. Claude is instructed to use milestones sparingly for genuinely formative moments.</done>
</task>

</tasks>

<verification>
1. `bun build --no-bundle src/relay.ts` — no syntax errors
2. `grep -n "saveMilestone\|MILESTONE\|milestone_saved" src/relay.ts` — all pieces present
3. The [MILESTONE:] intent follows the same pattern as existing intents (REMEMBER, GOAL, CRON)
4. save_milestone_moment RPC already exists (Phase 17) — relay just needs to call it
</verification>

<success_criteria>
- [MILESTONE:] intent parsed in processIntents() with optional WEIGHT and LESSON fields
- saveMilestone() helper calls save_milestone_moment RPC
- System prompt instructs Claude to tag formative moments (auto-detection + explicit)
- Heartbeat prompt allows MILESTONE tags
- Tags stripped from delivered messages
- Events logged to logs_v2 as milestone_saved
</success_criteria>

<output>
After completion, create `.planning/phases/20-milestone-moments/20-01-SUMMARY.md`
</output>
