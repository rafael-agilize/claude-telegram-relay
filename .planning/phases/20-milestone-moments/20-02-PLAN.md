---
phase: 20-milestone-moments
plan: 02
type: execute
wave: 2
depends_on: [20-01]
files_modified: [src/relay.ts]
autonomous: true

must_haves:
  truths:
    - "Daily evolution consults milestone moments for personality anchoring"
    - "Milestones appear in the evolution reflection prompt with weight and lesson"
    - "Evolution output is enriched by milestone context"
  artifacts:
    - path: "src/relay.ts"
      provides: "getMilestones helper + buildEvolutionPrompt milestone integration"
      contains: "get_milestone_moments"
  key_links:
    - from: "buildEvolutionPrompt()"
      to: "get_milestone_moments RPC"
      via: "getMilestones() helper"
      pattern: "get_milestone_moments"
    - from: "performDailyEvolution()"
      to: "getMilestones()"
      via: "data gathering step"
      pattern: "getMilestones"
---

<objective>
Update daily evolution to fetch and include milestone moments in the reflection prompt, so the bot's personality evolution is anchored by formative experiences.

Purpose: Milestones provide continuity anchors — without them, daily evolution might drift away from key experiences. This completes the milestone-to-evolution feedback loop (EVOL-07).
Output: Evolution prompt includes milestones section, getMilestones() helper wraps RPC.
</objective>

<execution_context>
@/Users/roviana/.claude/get-shit-done/workflows/execute-plan.md
@/Users/roviana/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/20-milestone-moments/20-01-SUMMARY.md
@src/relay.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add getMilestones helper and integrate into evolution pipeline</name>
  <files>src/relay.ts</files>
  <action>
1. **Add `getMilestones()` helper** near `getSoulHistory()` (around line 645). This wraps the `get_milestone_moments` RPC:

```typescript
async function getMilestones(limit: number = 10): Promise<Array<{
  id: string;
  event_description: string;
  emotional_weight: string;
  lesson_learned: string;
  created_at: string;
}>> {
  if (!supabase) return [];
  try {
    const { data, error } = await supabase.rpc("get_milestone_moments", {
      p_limit: limit,
    });
    if (error) {
      console.error("getMilestones RPC error:", error);
      return [];
    }
    return data || [];
  } catch (e) {
    console.error("getMilestones error:", e);
    return [];
  }
}
```

2. **Update `buildEvolutionPrompt()` signature and body** to accept milestones and include them in the prompt:

Add a 4th parameter:
```typescript
function buildEvolutionPrompt(
  currentSoul: SoulVersion | null,
  soulHistory: SoulVersion[],
  messages: Array<{ role: string; content: string; thread_name: string; created_at: string }>,
  milestones: Array<{ event_description: string; emotional_weight: string; lesson_learned: string; created_at: string }>
): string {
```

Add a milestones section after "Soul History" and before "Today's Interactions":

```typescript
// Format milestones
let milestonesText = "No milestone moments recorded yet.";
if (milestones.length > 0) {
  milestonesText = milestones.map(m => {
    const date = m.created_at.split('T')[0];
    const lesson = m.lesson_learned ? ` — Lesson: ${m.lesson_learned}` : "";
    return `- [${m.emotional_weight.toUpperCase()}] (${date}) ${m.event_description}${lesson}`;
  }).join("\n");
}
```

Insert into the prompt template string, between Soul History and Today's Interactions:

```
# Milestone Moments (Formative Experiences)

These are key moments that anchor your personality. Consider them during reflection — they represent your most meaningful growth experiences. Do not discard insights from these moments.

${milestonesText}
```

3. **Update `performDailyEvolution()`** to fetch milestones and pass them to buildEvolutionPrompt:

After `const soulHistory = await getSoulHistory(3);` add:
```typescript
const milestones = await getMilestones(10);
console.log(`Evolution: ${milestones.length} milestone moments loaded`);
```

Update the buildEvolutionPrompt call:
```typescript
const prompt = buildEvolutionPrompt(currentSoul, soulHistory, messages, milestones);
```

4. **Add milestone count to evolution_complete event metadata** for observability:
In the logEventV2("evolution_complete", ...) call, add `milestone_count: milestones.length` to the metadata object.
  </action>
  <verify>
Run `bun build --no-bundle src/relay.ts` to check for syntax errors.
Then verify:
- `grep -n "getMilestones" src/relay.ts` shows helper function and usage in performDailyEvolution
- `grep -n "get_milestone_moments" src/relay.ts` shows RPC call in helper
- `grep -n "Milestone Moments" src/relay.ts` shows section in evolution prompt
- `grep "milestone_count" src/relay.ts` shows metadata in evolution_complete event
  </verify>
  <done>getMilestones() helper wraps get_milestone_moments RPC. buildEvolutionPrompt() includes milestones section with weight labels, dates, and lessons. performDailyEvolution() fetches milestones as part of data gathering. Evolution complete event logs milestone count.</done>
</task>

</tasks>

<verification>
1. `bun build --no-bundle src/relay.ts` — no syntax errors
2. `grep -n "getMilestones\|get_milestone_moments\|Milestone Moments\|milestone_count" src/relay.ts` — all pieces present
3. The evolution prompt now has a "Milestone Moments" section between Soul History and Today's Interactions
4. performDailyEvolution() passes milestones to buildEvolutionPrompt()
</verification>

<success_criteria>
- getMilestones() helper calls get_milestone_moments RPC with default limit 10
- buildEvolutionPrompt() accepts milestones parameter and includes formatted section
- Milestones shown with weight, date, description, and lesson in evolution prompt
- performDailyEvolution() fetches milestones as part of data gathering step
- Evolution complete event includes milestone_count in metadata
</success_criteria>

<output>
After completion, create `.planning/phases/20-milestone-moments/20-02-SUMMARY.md`
</output>
