---
phase: 21-evolution-controls
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/20260216100000_evolution_enabled.sql
  - examples/supabase-schema-v2.sql
  - src/relay.ts
autonomous: true

must_haves:
  truths:
    - "/soul pause stops daily evolution and confirms to user"
    - "/soul resume restarts daily evolution and confirms to user"
    - "Evolution tick respects the evolution_enabled flag from database"
    - "/soul (no args) still shows current soul"
    - "/soul <text> still sets personality"
  artifacts:
    - path: "supabase/migrations/20260216100000_evolution_enabled.sql"
      provides: "evolution_enabled column on heartbeat_config"
      contains: "evolution_enabled"
    - path: "src/relay.ts"
      provides: "pause/resume subcommands and evolution gate"
      contains: "pause"
  key_links:
    - from: "src/relay.ts (evolutionTick)"
      to: "heartbeat_config.evolution_enabled"
      via: "Supabase query before running evolution"
      pattern: "evolution_enabled"
    - from: "src/relay.ts (/soul command)"
      to: "heartbeat_config.evolution_enabled"
      via: "UPDATE on pause/resume"
      pattern: "evolution_enabled"
---

<objective>
Add pause/resume evolution controls via /soul subcommands, gated by a new evolution_enabled flag in the database.

Purpose: Let Rafa freeze or unfreeze the daily soul evolution cycle from Telegram without stopping the relay.
Output: Migration SQL, updated /soul command handler, evolution tick gate.
</objective>

<execution_context>
@/Users/roviana/.claude/get-shit-done/workflows/execute-plan.md
@/Users/roviana/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/relay.ts
@examples/supabase-schema-v2.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add evolution_enabled column to heartbeat_config</name>
  <files>supabase/migrations/20260216100000_evolution_enabled.sql, examples/supabase-schema-v2.sql</files>
  <action>
Create migration `supabase/migrations/20260216100000_evolution_enabled.sql`:
- ALTER TABLE heartbeat_config ADD COLUMN IF NOT EXISTS evolution_enabled BOOLEAN DEFAULT true;
- Comment: "v1.4 Phase 21: Evolution pause/resume control"

Update `examples/supabase-schema-v2.sql`:
- Add `evolution_enabled BOOLEAN DEFAULT true` to the heartbeat_config CREATE TABLE block
- Add comment about evolution controls (Phase 21)
  </action>
  <verify>File exists with valid SQL. Schema reference updated.</verify>
  <done>Migration adds evolution_enabled column defaulting to true. Reference schema updated.</done>
</task>

<task type="auto">
  <name>Task 2: Extend /soul command with pause/resume and gate evolutionTick</name>
  <files>src/relay.ts</files>
  <action>
**1. Refactor /soul command handler** (currently at ~line 2852):

The current handler checks `if (!text || text.trim().length === 0)` for show, otherwise sets soul. Refactor to parse subcommands:

```
const args = text?.trim() || "";
const subcommand = args.split(/\s+/)[0]?.toLowerCase();
```

Handle these subcommands:
- `""` (empty): Show current soul (existing behavior — use formatSoulForPrompt() instead of getActiveSoul() so it shows the 3-layer version)
- `"pause"`: UPDATE heartbeat_config SET evolution_enabled = false, updated_at = NOW(). Reply: "Evolution paused. Current soul is frozen. Use /soul resume to restart." Log event: `evolution_paused`.
- `"resume"`: UPDATE heartbeat_config SET evolution_enabled = true, updated_at = NOW(). Reply: "Evolution resumed. Daily reflection will continue." Log event: `evolution_resumed`.
- Any other text: Treat as personality set (existing behavior — `setSoul(args)`)

For pause/resume, query Supabase directly:
```typescript
const { error } = await supabase!.from("heartbeat_config").update({ evolution_enabled: false, updated_at: new Date().toISOString() }).eq("id", configId);
```

Since heartbeat_config is single-row, use `.limit(1)` or just update all rows without a WHERE (there's only ever one row). Pattern: first SELECT to get current state (so we can tell user "already paused" / "already resumed"), then UPDATE.

**2. Gate evolutionTick()** (at ~line 1626):

Add an early check in `evolutionTick()`, right after the `evolutionRunning` guard:

```typescript
// Check if evolution is enabled
if (supabase) {
  const { data } = await supabase.from("heartbeat_config").select("evolution_enabled").limit(1).single();
  if (data && data.evolution_enabled === false) {
    return; // Silently skip — evolution is paused
  }
}
```

This goes BEFORE the hour check so we don't even bother checking the time if paused.

**Important:** Do NOT add a new bot.command — extend the EXISTING /soul command handler. The subcommand parsing must preserve backward compatibility: `/soul some personality text` still sets the soul.
  </action>
  <verify>
Search relay.ts for "pause" and "resume" strings in the /soul handler. Confirm evolutionTick checks evolution_enabled. Confirm `/soul <text>` still calls setSoul. Run `bun check` or `bunx tsc --noEmit` if available.
  </verify>
  <done>
/soul pause sets evolution_enabled=false and confirms. /soul resume sets evolution_enabled=true and confirms. evolutionTick() skips silently when paused. Existing /soul behavior (show and set) preserved.
  </done>
</task>

</tasks>

<verification>
- Grep relay.ts for "evolution_enabled" — should appear in both /soul handler and evolutionTick
- Grep relay.ts for "evolution_paused" and "evolution_resumed" — log events exist
- Migration file exists with ALTER TABLE
- Reference schema includes evolution_enabled column
</verification>

<success_criteria>
1. /soul pause stops evolution by setting evolution_enabled=false in DB
2. /soul resume restarts evolution by setting evolution_enabled=true in DB
3. evolutionTick() respects the flag and skips silently when paused
4. /soul (no args) shows current soul, /soul <text> sets soul — backward compatible
</success_criteria>

<output>
After completion, create `.planning/phases/21-evolution-controls/21-01-SUMMARY.md`
</output>
