---
phase: 21-evolution-controls
plan: 02
type: execute
wave: 2
depends_on: ["01"]
files_modified:
  - src/relay.ts
autonomous: true

must_haves:
  truths:
    - "/soul history shows recent soul versions with version number, date, and token count"
    - "/soul rollback <version> restores that version as the new active soul"
    - "Rollback creates a NEW version (preserves full history, no deletion)"
    - "Rollback of non-existent version returns clear error message"
  artifacts:
    - path: "src/relay.ts"
      provides: "history and rollback subcommands in /soul handler"
      contains: "rollback"
  key_links:
    - from: "src/relay.ts (/soul history)"
      to: "getSoulHistory()"
      via: "function call with limit=10"
      pattern: "getSoulHistory"
    - from: "src/relay.ts (/soul rollback)"
      to: "save_soul_version RPC"
      via: "reads old version, saves as new version"
      pattern: "save_soul_version"
---

<objective>
Add history and rollback subcommands to /soul, letting Rafa view past soul versions and restore any previous version.

Purpose: Give the user full control to inspect and undo soul evolution if the bot drifts in an undesired direction.
Output: Extended /soul command with history and rollback subcommands.
</objective>

<execution_context>
@/Users/roviana/.claude/get-shit-done/workflows/execute-plan.md
@/Users/roviana/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/21-evolution-controls/21-01-SUMMARY.md
@src/relay.ts
@examples/supabase-schema-v2.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add /soul history subcommand</name>
  <files>src/relay.ts</files>
  <action>
In the /soul command handler (extended by plan 21-01 with pause/resume), add a `"history"` case to the subcommand switch.

**Implementation:**

```typescript
case "history": {
  const versions = await getSoulHistory(10);
  if (versions.length === 0) {
    await ctx.reply("No soul versions yet. Evolution hasn't run.");
    return;
  }

  const lines = versions.map((v) => {
    const date = new Date(v.created_at).toLocaleDateString("en-US", {
      month: "short", day: "numeric", year: "numeric",
      timeZone: EVOLUTION_TIMEZONE,
    });
    return `v${v.version} (${date}) — ${v.token_count} tokens`;
  });

  await ctx.reply(
    `Soul Version History (last ${versions.length}):\n\n${lines.join("\n")}\n\nUse /soul rollback <version> to restore.`
  );
  return;
}
```

Key details:
- Reuse existing `getSoulHistory()` function (already returns id, version, core_identity, active_values, recent_growth, token_count, created_at)
- Format dates using EVOLUTION_TIMEZONE for consistency
- Show version number, date, token count per line
- Include rollback hint at the bottom
- Telegram message formatting: plain text, no markdown (safe for all characters)
  </action>
  <verify>Grep relay.ts for "Soul Version History" — string exists in /soul handler.</verify>
  <done>/soul history displays up to 10 recent versions with version numbers, dates, and token counts.</done>
</task>

<task type="auto">
  <name>Task 2: Add /soul rollback subcommand</name>
  <files>src/relay.ts</files>
  <action>
In the /soul command handler, add a `"rollback"` case.

**Implementation:**

```typescript
case "rollback": {
  const versionArg = args.split(/\s+/)[1];
  const targetVersion = parseInt(versionArg, 10);

  if (isNaN(targetVersion) || targetVersion < 0) {
    await ctx.reply("Usage: /soul rollback <version>\nExample: /soul rollback 3\n\nUse /soul history to see available versions.");
    return;
  }

  if (!supabase) {
    await ctx.reply("Supabase not available.");
    return;
  }

  // Fetch the target version from soul_versions
  const { data: targetData, error: fetchError } = await supabase
    .from("soul_versions")
    .select("version, core_identity, active_values, recent_growth, token_count")
    .eq("version", targetVersion)
    .single();

  if (fetchError || !targetData) {
    await ctx.reply(`Version ${targetVersion} not found. Use /soul history to see available versions.`);
    return;
  }

  // Save as NEW version (preserves history — rollback creates a new entry, never deletes)
  const { data: newVersion, error: saveError } = await supabase.rpc("save_soul_version", {
    p_core_identity: targetData.core_identity,
    p_active_values: targetData.active_values,
    p_recent_growth: targetData.recent_growth,
    p_reflection_notes: `Rollback to v${targetVersion} by user`,
    p_token_count: targetData.token_count || 0,
  });

  if (saveError) {
    await ctx.reply(`Rollback failed: ${saveError.message}`);
    return;
  }

  await logEventV2("soul_rollback", `Rolled back to v${targetVersion}, created v${newVersion}`, {
    from_version: targetVersion,
    new_version: newVersion,
  }, ctx.threadInfo?.dbId);

  await ctx.reply(`Rolled back to v${targetVersion}. Created as new v${newVersion}.\n\nThe previous soul is preserved in history.`);
  return;
}
```

Key details:
- Parse version number from second arg: `/soul rollback 3` -> targetVersion = 3
- Query soul_versions table directly by version number (not RPC, since get_soul_history excludes reflection_notes and we just need the layers)
- Call save_soul_version RPC to create a NEW version with the old layers — this preserves full history
- reflection_notes records that this was a rollback
- Log event with both source version and new version number
- Clear error messages for missing args, invalid version, not found
  </action>
  <verify>Grep relay.ts for "soul_rollback" — log event exists. Grep for "save_soul_version" in rollback case. Grep for "Rolled back to" — confirmation message exists.</verify>
  <done>
/soul rollback <version> fetches the target version's layers, saves them as a new version via save_soul_version RPC, confirms to user. History fully preserved (no deletion). Invalid/missing version returns helpful error.
  </done>
</task>

</tasks>

<verification>
- Grep relay.ts for "history" and "rollback" in /soul handler — both subcommands exist
- Grep for "getSoulHistory" — called with limit 10 for history display
- Grep for "soul_rollback" — log event recorded
- Grep for "save_soul_version" — used in rollback to create new version
- Confirm: rollback does NOT delete any rows from soul_versions
</verification>

<success_criteria>
1. /soul history shows last 10 versions with version number, date, token count
2. /soul rollback <version> restores target version as new active soul
3. Rollback creates a NEW version number (history preserved, no deletion)
4. Invalid version number returns clear error with usage hint
5. All /soul subcommands coexist: (empty), pause, resume, history, rollback, <text>
</success_criteria>

<output>
After completion, create `.planning/phases/21-evolution-controls/21-02-SUMMARY.md`
</output>
