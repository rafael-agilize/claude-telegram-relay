---
phase: 17-three-layer-soul-schema
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/20260215100000_soul_versions_milestones.sql
  - examples/supabase-schema-v2.sql
autonomous: true

must_haves:
  truths:
    - "soul_versions table exists with core_identity, active_values, recent_growth, reflection_notes, token_count, and version columns"
    - "soul_milestones table exists with emotional_weight classification and lesson_learned"
    - "Current bot_soul content is preserved as version 0 seed in soul_versions"
    - "RLS policies restrict access to service_role only"
  artifacts:
    - path: "supabase/migrations/20260215100000_soul_versions_milestones.sql"
      provides: "Migration creating soul_versions and soul_milestones tables with seed data"
      contains: "CREATE TABLE IF NOT EXISTS soul_versions"
    - path: "examples/supabase-schema-v2.sql"
      provides: "Updated reference schema with new tables"
      contains: "SOUL VERSIONS TABLE"
  key_links:
    - from: "soul_versions"
      to: "bot_soul"
      via: "Seed migration copies active bot_soul content into soul_versions as version 0"
      pattern: "INSERT INTO soul_versions.*SELECT.*FROM bot_soul"
---

<objective>
Create the database tables for the 3-layer soul versioning system and milestone moments storage.

Purpose: Establish the schema foundation that Phase 18+ will build on — soul_versions stores daily snapshots of the 3-layer compressed soul, and soul_milestones stores formative events that anchor personality evolution.
Output: Migration SQL file + updated reference schema
</objective>

<execution_context>
@/Users/roviana/.claude/get-shit-done/workflows/execute-plan.md
@/Users/roviana/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@examples/supabase-schema-v2.sql
@supabase/migrations/20260213100000_typed_memory_schema.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create migration SQL for soul_versions and soul_milestones tables</name>
  <files>supabase/migrations/20260215100000_soul_versions_milestones.sql</files>
  <action>
Create a migration file following the established pattern (see `20260213100000_typed_memory_schema.sql` for style).

**soul_versions table:**
```sql
CREATE TABLE IF NOT EXISTS soul_versions (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  version INTEGER NOT NULL,
  core_identity TEXT NOT NULL,        -- Layer 1: Who I am (stable, ~200 tokens)
  active_values TEXT NOT NULL,        -- Layer 2: What I care about now (~300 tokens)
  recent_growth TEXT NOT NULL,        -- Layer 3: What I learned recently (~300 tokens)
  reflection_notes TEXT,              -- Uncompressed journal entry (not loaded into prompt)
  token_count INTEGER NOT NULL DEFAULT 0,  -- Actual token count of L1+L2+L3 combined
  UNIQUE(version)
);
```
- Index on `created_at DESC` for history queries
- Index on `version DESC` for latest-version lookup

**soul_milestones table:**
```sql
CREATE TABLE IF NOT EXISTS soul_milestones (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  event_description TEXT NOT NULL,
  emotional_weight TEXT NOT NULL DEFAULT 'meaningful'
    CHECK (emotional_weight IN ('formative', 'meaningful', 'challenging')),
  lesson_learned TEXT NOT NULL,
  source_thread_id UUID REFERENCES threads(id) ON DELETE SET NULL
);
```
- Index on `created_at DESC`
- Index on `emotional_weight` for filtering by weight class

**Seed migration:**
```sql
INSERT INTO soul_versions (version, core_identity, active_values, recent_growth, reflection_notes, token_count)
SELECT
  0,
  bs.content,
  '',
  '',
  'Seed from original bot_soul at migration time',
  0
FROM bot_soul bs
WHERE bs.is_active = true
ORDER BY bs.updated_at DESC
LIMIT 1
ON CONFLICT (version) DO NOTHING;
```
This preserves the current active soul as version 0 (Layer 1 seed). active_values and recent_growth start empty — the daily evolution engine (Phase 19) will populate them.

**RLS:**
- Enable RLS on both tables
- Add `service_role_all` policies (same pattern as all other tables)

All statements must be idempotent (IF NOT EXISTS, CREATE OR REPLACE, ON CONFLICT DO NOTHING).
  </action>
  <verify>
Read the migration file and confirm:
1. Both tables have correct columns and constraints
2. soul_versions has UNIQUE(version) constraint
3. soul_milestones has CHECK constraint on emotional_weight with 3 values
4. Seed INSERT selects from bot_soul WHERE is_active=true
5. RLS enabled with service_role_all policies on both tables
6. All indexes created with IF NOT EXISTS
  </verify>
  <done>Migration file creates soul_versions (with version, core_identity, active_values, recent_growth, reflection_notes, token_count) and soul_milestones (with emotional_weight CHECK, lesson_learned) tables, seeds version 0 from bot_soul, enables RLS</done>
</task>

<task type="auto">
  <name>Task 2: Update reference schema with new tables</name>
  <files>examples/supabase-schema-v2.sql</files>
  <action>
Add two new sections to `examples/supabase-schema-v2.sql` after the BOT SOUL TABLE section and before the LOGS TABLE section:

1. **SOUL VERSIONS TABLE** section — full CREATE TABLE with all columns, indexes, and comments explaining the 3-layer structure
2. **SOUL MILESTONES TABLE** section — full CREATE TABLE with all columns, indexes

Also add at the bottom (in the RLS section):
- `ALTER TABLE soul_versions ENABLE ROW LEVEL SECURITY;`
- `ALTER TABLE soul_milestones ENABLE ROW LEVEL SECURITY;`
- Two `service_role_all` policies

Do NOT modify any existing sections. Follow the exact comment/spacing style of existing sections (see the `-- ============================================================` separator pattern).
  </action>
  <verify>
Read examples/supabase-schema-v2.sql and confirm:
1. SOUL VERSIONS TABLE section exists after BOT SOUL section
2. SOUL MILESTONES TABLE section exists after SOUL VERSIONS section
3. RLS and policies added for both new tables
4. All existing content preserved unchanged
  </verify>
  <done>Reference schema includes soul_versions and soul_milestones table definitions with RLS policies, preserving all existing content</done>
</task>

</tasks>

<verification>
1. Migration file exists at `supabase/migrations/20260215100000_soul_versions_milestones.sql`
2. soul_versions table: id, created_at, version (UNIQUE), core_identity, active_values, recent_growth, reflection_notes, token_count
3. soul_milestones table: id, created_at, event_description, emotional_weight (CHECK 3 values), lesson_learned, source_thread_id (FK)
4. Seed migration copies active bot_soul into version 0
5. RLS enabled with service_role_all on both tables
6. Reference schema updated with both tables
</verification>

<success_criteria>
- Both new tables defined with correct columns, types, constraints, and indexes
- Seed migration preserves current bot_soul content as version 0 in soul_versions
- All SQL is idempotent (safe to re-run)
- Reference schema reflects the new tables
</success_criteria>

<output>
After completion, create `.planning/phases/17-three-layer-soul-schema/17-01-SUMMARY.md`
</output>
