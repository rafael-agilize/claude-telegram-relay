---
phase: 25-intent-validation-input-hardening
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [src/relay.ts]
autonomous: true

must_haves:
  truths:
    - "FORGET intent with <10 char search text is rejected with warning log"
    - "FORGET intent only deletes entries where search text overlaps >50% with content"
    - "Per-response caps enforced: max 5 REMEMBER, 3 GOAL, 1 CRON, 3 FORGET"
    - "Duplicate REMEMBER/GOAL content within same response is skipped"
  artifacts:
    - path: "src/relay.ts"
      provides: "Hardened processIntents() and deleteMemory()"
      contains: "contentOverlap"
  key_links:
    - from: "processIntents()"
      to: "deleteMemory()"
      via: "FORGET intent block calls deleteMemory with validated search text"
      pattern: "searchText\\.length.*>=.*10"
---

<objective>
Harden intent validation in processIntents() with FORGET safety guards and per-response intent caps.

Purpose: Prevent prompt injection from mass-deleting memories via short/vague FORGET searches and from flooding memory with unlimited REMEMBER/GOAL intents in a single response.
Output: Updated processIntents() with FORGET validation (min length + overlap check) and per-response counters with deduplication.
</objective>

<execution_context>
@/Users/roviana/.claude/get-shit-done/workflows/execute-plan.md
@/Users/roviana/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/relay.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Harden FORGET validation with minimum length and content overlap check</name>
  <files>src/relay.ts</files>
  <action>
Two changes in `src/relay.ts`:

**1. Add content overlap helper function** (place near `deleteMemory`, around line 428):

```typescript
function contentOverlap(searchText: string, content: string): number {
  const searchWords = new Set(searchText.toLowerCase().split(/\s+/).filter(w => w.length > 2));
  const contentWords = new Set(content.toLowerCase().split(/\s+/).filter(w => w.length > 2));
  if (searchWords.size === 0) return 0;
  let matches = 0;
  for (const word of searchWords) {
    if (contentWords.has(word)) matches++;
  }
  return matches / searchWords.size;
}
```

This computes word-level overlap between search text and content. Words <= 2 chars are filtered out (stop words like "a", "is", "to"). Returns ratio 0.0-1.0.

**2. Update `deleteMemory()` function** (line ~394):

- Add minimum search text length check: reject if `searchText.length < 10` (currently only checks > 200). Log warning with the short search text.
- After finding a match via `.includes()`, compute `contentOverlap(searchText, match.content)` and reject if overlap < 0.5. Log warning: `deleteMemory: low overlap (${overlap}) for "${searchText}" vs "${match.content.substring(0, 50)}"`

The existing `.includes()` check stays as the initial filter; the overlap check is an additional safety gate on the found match.

**3. Update FORGET intent block in `processIntents()`** (line ~2211):

Currently the FORGET block has no length validation (unlike REMEMBER/GOAL). Add a guard after the allowlist check:
- If `searchText.length < 10`: log warning `[Intents] Rejected FORGET: search text too short (${searchText.length} chars)`, add to failures array, skip `deleteMemory()` call.
- Keep the existing `searchText.length > 200` cap that's already in `deleteMemory()`.
  </action>
  <verify>
Search for `contentOverlap` function definition in relay.ts. Verify `deleteMemory` has the `< 10` length check and overlap >= 0.5 check. Verify the FORGET block in processIntents has the `< 10` guard before calling deleteMemory.
  </verify>
  <done>FORGET rejects search text under 10 chars at both processIntents and deleteMemory levels. Matches require >50% word overlap. contentOverlap helper exists and is used.</done>
</task>

<task type="auto">
  <name>Task 2: Add per-response intent caps and content deduplication</name>
  <files>src/relay.ts</files>
  <action>
Modify `processIntents()` in `src/relay.ts` to enforce per-response caps and deduplication.

**1. Add cap constants** near the top of processIntents() (after `const allowed = INTENT_ALLOWLIST[context];`):

```typescript
const INTENT_CAPS: Record<string, number> = { REMEMBER: 5, GOAL: 3, CRON: 1, FORGET: 3 };
const intentCounts: Record<string, number> = { REMEMBER: 0, GOAL: 0, CRON: 0, FORGET: 0 };
const seenContent = new Set<string>();
```

**2. Update REMEMBER block** (the `for (const match of rememberMatches)` loop):
- After the allowlist check, before inserting: increment `intentCounts.REMEMBER`. If count exceeds `INTENT_CAPS.REMEMBER`, log warning `[Intents] REMEMBER cap reached (${INTENT_CAPS.REMEMBER}), skipping: ${fact.substring(0, 50)}` and skip (don't call insertMemory).
- For dedup: normalize content with `fact.toLowerCase().trim()`. If `seenContent.has(normalized)`, log `[Intents] Duplicate REMEMBER skipped: ${fact.substring(0, 50)}` and skip. Otherwise `seenContent.add(normalized)`.

**3. Update GOAL block** similarly:
- Check `intentCounts.GOAL` against `INTENT_CAPS.GOAL`. Skip if over cap.
- Dedup via `seenContent` with `goalText.toLowerCase().trim()`.

**4. Update CRON block**:
- Check `intentCounts.CRON` against `INTENT_CAPS.CRON` (1). Skip if over cap. Log warning.
- No dedup needed (cap is 1).

**5. Update FORGET block**:
- Check `intentCounts.FORGET` against `INTENT_CAPS.FORGET` (3). Skip if over cap.
- No dedup needed for FORGET.

Tags are always stripped from response regardless of cap/dedup â€” only the action is skipped.
  </action>
  <verify>
Search relay.ts for `INTENT_CAPS` constant. Verify each intent block (REMEMBER, GOAL, CRON, FORGET) increments its counter and checks against the cap. Verify `seenContent` dedup is used for REMEMBER and GOAL blocks.
  </verify>
  <done>Per-response caps enforced: max 5 REMEMBER, 3 GOAL, 1 CRON, 3 FORGET. Duplicate REMEMBER and GOAL content within same response is skipped via seenContent Set.</done>
</task>

</tasks>

<verification>
1. `contentOverlap` function exists and returns number between 0 and 1
2. `deleteMemory` rejects searchText < 10 chars
3. `deleteMemory` rejects matches with < 50% overlap
4. `INTENT_CAPS` constant defines limits for REMEMBER(5), GOAL(3), CRON(1), FORGET(3)
5. `seenContent` Set used for REMEMBER and GOAL deduplication
6. All intent tags still stripped from response regardless of cap/dedup/block
7. TypeScript compiles without errors: `bunx tsc --noEmit src/relay.ts` or `bun build src/relay.ts --no-bundle`
</verification>

<success_criteria>
- FORGET with short search text (< 10 chars) is rejected
- FORGET only deletes entries with > 50% word overlap
- 6th REMEMBER intent in single response is silently skipped
- 4th GOAL intent in single response is silently skipped
- 2nd CRON intent in single response is silently skipped
- Duplicate REMEMBER facts within same response are skipped
- All intent tags still cleaned from response text
</success_criteria>

<output>
After completion, create `.planning/phases/25-intent-validation-input-hardening/25-01-SUMMARY.md`
</output>
