---
phase: 15-intent-system-upgrade
plan: 01
type: execute
wave: 1
depends_on: ["14-01"]
files_modified:
  - src/relay.ts
autonomous: true

must_haves:
  truths:
    - "[LEARN:] regex replaced with [REMEMBER:] in processIntents() — old tag no longer recognized"
    - "[GOAL: text] and [GOAL: text | DEADLINE: date] parsed in processIntents() and inserted with type='goal'"
    - "[DONE: search text] parsed in processIntents(), matching goal updated to type='completed_goal' with completed_at"
    - "[FORGET:] intent unchanged"
    - "/memory command shows facts and active goals in separate sections"
    - "insertGlobalMemory renamed to insertMemory with type parameter"
    - "deleteGlobalMemory renamed to deleteMemory"
    - "getGlobalMemory renamed to getMemoryContext (returns facts only via get_facts() RPC)"
    - "New getActiveGoals() function uses get_active_goals() RPC"
    - "New completeGoal() function marks matching goal as completed_goal"
    - "buildPrompt() instructions reference [REMEMBER:], [GOAL:], [DONE:] — no mention of [LEARN:]"
    - "Active goals shown in prompt context alongside facts"
  artifacts:
    - path: "src/relay.ts"
      provides: "Intent system upgrade with renamed tags, goals lifecycle, updated memory functions"
      contains: "REMEMBER:"
  key_links:
    - from: "processIntents() [REMEMBER:]"
      to: "insertMemory()"
      via: "fact insertion with type='fact'"
      pattern: "insertMemory(fact, 'fact'"
    - from: "processIntents() [GOAL:]"
      to: "insertMemory()"
      via: "goal insertion with type='goal'"
      pattern: "insertMemory(goalText, 'goal'"
    - from: "processIntents() [DONE:]"
      to: "completeGoal()"
      via: "marks matching goal as completed"
      pattern: "completeGoal(searchText)"
    - from: "getMemoryContext()"
      to: "get_facts() Supabase RPC"
      via: "RPC call returns fact-type entries only"
      pattern: "supabase.rpc('get_facts')"
    - from: "getActiveGoals()"
      to: "get_active_goals() Supabase RPC"
      via: "RPC call returns active goals"
      pattern: "supabase.rpc('get_active_goals')"
---

<objective>
Upgrade the intent system in relay.ts to support typed memory: rename [LEARN:] → [REMEMBER:], add [GOAL:] and [DONE:] intents for goals lifecycle, rename Supabase helper functions to match new semantics, and update all prompt builders and the /memory command.

Purpose: This is the relay-side implementation of v1.3 Smart Memory. Phase 14 created the database schema (typed columns, RPCs). This phase wires the relay code to use those new capabilities.
Output: Updated src/relay.ts with new intent parsing, renamed functions, goals in prompt context, and separated /memory display.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@.planning/phases/14-schema-migration-typed-memory/14-01-PLAN.md
@examples/supabase-schema-v2.sql
@src/relay.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rename and update Supabase memory helper functions</name>
  <files>src/relay.ts</files>
  <action>
Rename three existing functions and add two new ones. All changes in src/relay.ts.

**1a. Rename `getGlobalMemory()` → `getMemoryContext()` (line ~346)**

Replace the entire function. The new version calls the `get_facts()` RPC from Phase 14 instead of querying the table directly. This ensures only fact-type entries are returned (not goals).

```typescript
async function getMemoryContext(): Promise<string[]> {
  if (!supabase) return [];
  try {
    const { data } = await supabase.rpc("get_facts");
    return (data || []).map((m: { content: string }) => m.content);
  } catch (e) {
    console.error("getMemoryContext error:", e);
    return [];
  }
}
```

**1b. Rename `insertGlobalMemory()` → `insertMemory()` (line ~361)**

Replace the entire function. Add `type`, `deadline`, and `priority` parameters:

```typescript
async function insertMemory(
  content: string,
  type: string = "fact",
  sourceThreadId?: string,
  deadline?: string | null,
  priority?: number
): Promise<void> {
  if (!supabase) return;
  try {
    const row: Record<string, unknown> = {
      content,
      type,
      source_thread_id: sourceThreadId || null,
    };
    if (deadline) {
      const parsed = new Date(deadline);
      if (!isNaN(parsed.getTime())) {
        row.deadline = parsed.toISOString();
      } else {
        console.warn(`Could not parse deadline: "${deadline}"`);
      }
    }
    if (priority !== undefined) {
      row.priority = priority;
    }
    await supabase.from("global_memory").insert(row);
  } catch (e) {
    console.error("insertMemory error:", e);
  }
}
```

**1c. Rename `deleteGlobalMemory()` → `deleteMemory()` (line ~375)**

Rename function and all internal references. The logic stays the same:

```typescript
async function deleteMemory(searchText: string): Promise<boolean> {
  if (!supabase) return false;
  if (!searchText || searchText.length > 200) return false;
  try {
    const { data: items } = await supabase
      .from("global_memory")
      .select("id, content")
      .limit(100);
    const match = items?.find((m: { id: string; content: string }) =>
      m.content.toLowerCase().includes(searchText.toLowerCase())
    );
    if (match) {
      await supabase.from("global_memory").delete().eq("id", match.id);
      console.log(`Forgot memory: ${match.content}`);
      return true;
    }
    return false;
  } catch (e) {
    console.error("deleteMemory error:", e);
    return false;
  }
}
```

**1d. Add new `getActiveGoals()` function** — insert immediately after `deleteMemory()`:

```typescript
async function getActiveGoals(): Promise<
  Array<{ content: string; deadline: string | null; priority: number }>
> {
  if (!supabase) return [];
  try {
    const { data } = await supabase.rpc("get_active_goals");
    return (data || []).map(
      (g: { content: string; deadline: string | null; priority: number }) => ({
        content: g.content,
        deadline: g.deadline,
        priority: g.priority,
      })
    );
  } catch (e) {
    console.error("getActiveGoals error:", e);
    return [];
  }
}
```

**1e. Add new `completeGoal()` function** — insert immediately after `getActiveGoals()`:

```typescript
async function completeGoal(searchText: string): Promise<boolean> {
  if (!supabase) return false;
  if (!searchText || searchText.length > 200) return false;
  try {
    const { data: goals } = await supabase
      .from("global_memory")
      .select("id, content")
      .eq("type", "goal")
      .is("completed_at", null)
      .limit(100);
    const match = goals?.find((g: { id: string; content: string }) =>
      g.content.toLowerCase().includes(searchText.toLowerCase())
    );
    if (match) {
      await supabase
        .from("global_memory")
        .update({ type: "completed_goal", completed_at: new Date().toISOString() })
        .eq("id", match.id);
      console.log(`Goal completed: ${match.content}`);
      return true;
    }
    return false;
  } catch (e) {
    console.error("completeGoal error:", e);
    return false;
  }
}
```

**1f. Update ALL call sites of the renamed functions:**

There are 6 call sites to update:

| Old call | New call | Location |
|----------|----------|----------|
| `getGlobalMemory()` | `getMemoryContext()` | line ~802 (cron job prompt builder) |
| `getGlobalMemory()` | `getMemoryContext()` | line ~1252 (heartbeat prompt builder) |
| `getGlobalMemory()` | `getMemoryContext()` | line ~2104 (/memory command handler) |
| `getGlobalMemory()` | `getMemoryContext()` | line ~2517 (main buildPrompt) |
| `insertGlobalMemory(fact, threadDbId)` | `insertMemory(fact, "fact", threadDbId)` | line ~1378 (processIntents) |
| `deleteGlobalMemory(searchText)` | `deleteMemory(searchText)` | line ~1390 (processIntents) |

Also rename the variable `globalMemory` to `memoryFacts` at lines ~802, ~1252, ~2517 for clarity, and update all references to that variable in the same scope.

**1g. Update comment on line ~8:**

Change `[LEARN:]/[FORGET:]` to `[REMEMBER:]/[FORGET:]/[GOAL:]/[DONE:]`.
  </action>
  <verify>
Verify function renames:
1. No references to `getGlobalMemory` remain in the file
2. No references to `insertGlobalMemory` remain in the file
3. No references to `deleteGlobalMemory` remain in the file
4. `getMemoryContext` function exists and calls `supabase.rpc("get_facts")`
5. `insertMemory` function exists and accepts `type` parameter
6. `deleteMemory` function exists
7. `getActiveGoals` function exists and calls `supabase.rpc("get_active_goals")`
8. `completeGoal` function exists and updates type to `completed_goal`
9. All 6 call sites use new function names
10. No TypeScript compilation errors (run `bun build src/relay.ts --no-bundle 2>&1 | head -20` or equivalent type check)
  </verify>
  <done>All memory functions renamed, type parameter added to insertMemory, new getActiveGoals and completeGoal functions created, all call sites updated.</done>
</task>

<task type="auto">
  <name>Task 2: Update processIntents() with new intent tags</name>
  <files>src/relay.ts</files>
  <action>
Modify the `processIntents()` function (line ~1369) to replace `[LEARN:]` with `[REMEMBER:]` and add `[GOAL:]` and `[DONE:]` intent parsing.

**2a. Replace `[LEARN:]` regex with `[REMEMBER:]`** (line ~1372-1384):

Change the regex from:
```typescript
const learnMatches = response.matchAll(/\[LEARN:\s*(.+?)\]/gi);
```
to:
```typescript
const rememberMatches = response.matchAll(/\[REMEMBER:\s*(.+?)\]/gi);
```

Update the variable name from `learnMatches` to `rememberMatches` in the for loop. Update the log from `Learned:` to `Remembered:`. Update the warning from `Rejected LEARN fact:` to `Rejected REMEMBER fact:`.

The `insertMemory` call should now be:
```typescript
await insertMemory(fact, "fact", threadDbId);
console.log(`Remembered: ${fact}`);
```

**2b. Add `[GOAL:]` intent parsing** — insert after the REMEMBER block, before the FORGET block:

```typescript
// [GOAL: text] or [GOAL: text | DEADLINE: date]
const goalMatches = response.matchAll(
  /\[GOAL:\s*(.+?)(?:\s*\|\s*DEADLINE:\s*(.+?))?\]/gi
);
for (const match of goalMatches) {
  const goalText = match[1].trim();
  const deadline = match[2]?.trim() || null;
  if (goalText.length > 0 && goalText.length <= 200) {
    await insertMemory(goalText, "goal", threadDbId, deadline);
    console.log(
      `Goal set: ${goalText}${deadline ? ` (deadline: ${deadline})` : ""}`
    );
  } else if (goalText.length > 200) {
    console.warn(`Rejected GOAL: too long (${goalText.length} chars)`);
  }
  clean = clean.replace(match[0], "");
}
```

**2c. Add `[DONE:]` intent parsing** — insert after the GOAL block, before the FORGET block:

```typescript
// [DONE: search text to mark a goal as completed]
const doneMatches = response.matchAll(/\[DONE:\s*(.+?)\]/gi);
for (const match of doneMatches) {
  const searchText = match[1].trim();
  if (searchText.length > 0 && searchText.length <= 200) {
    const completed = await completeGoal(searchText);
    if (completed) {
      console.log(`Goal completed matching: ${searchText}`);
    } else {
      console.warn(`No active goal found matching: ${searchText}`);
    }
  }
  clean = clean.replace(match[0], "");
}
```

**Processing order in the function should be:**
1. `[REMEMBER:]` — save facts
2. `[GOAL:]` — create goals
3. `[DONE:]` — complete goals
4. `[FORGET:]` — delete any memory entry
5. `[CRON:]` — create scheduled jobs

Also update the comment at line ~1004 from `[LEARN:]` to `[REMEMBER:]`.
  </action>
  <verify>
Verify processIntents:
1. No `[LEARN:]` regex in processIntents (grep for `/\[LEARN:`)
2. `[REMEMBER:]` regex present and correctly matches tags
3. `[GOAL:]` regex present, handles both `[GOAL: text]` and `[GOAL: text | DEADLINE: date]`
4. `[DONE:]` regex present and calls `completeGoal()`
5. `[FORGET:]` regex still present and unchanged
6. `[CRON:]` regex still present and unchanged
7. All 5 intent tags are stripped from the response (clean = clean.replace)
8. Security guards: REMEMBER facts capped at 200 chars, GOAL text capped at 200 chars, DONE text capped at 200 chars
  </verify>
  <done>processIntents() now handles 5 intent types: REMEMBER, GOAL, DONE, FORGET, CRON. Old LEARN tag removed.</done>
</task>

<task type="auto">
  <name>Task 3: Update prompt builders with new intent instructions and goals context</name>
  <files>src/relay.ts</files>
  <action>
Update three prompt builder functions to use new intent names and include active goals in context.

**3a. Update main `buildPrompt()` (line ~2501):**

First, change the global memory fetch to also fetch goals:

Replace:
```typescript
// Layer 2: Global memory (cross-thread learned facts)
const globalMemory = await getGlobalMemory();
```
With:
```typescript
// Layer 2: Memory context (facts + active goals)
const memoryFacts = await getMemoryContext();
const activeGoals = await getActiveGoals();
```

Update the facts section (line ~2536-2539):
```typescript
if (memoryFacts.length > 0) {
  prompt += "\n\nTHINGS I KNOW ABOUT THE USER:\n";
  prompt += memoryFacts.map((m) => `- ${m}`).join("\n");
}
```

Add active goals section right after the facts section:
```typescript
if (activeGoals.length > 0) {
  prompt += "\n\nACTIVE GOALS:\n";
  prompt += activeGoals
    .map((g) => {
      let line = `- ${g.content}`;
      if (g.deadline) {
        const d = new Date(g.deadline);
        line += ` (deadline: ${d.toLocaleDateString("en-US", { month: "short", day: "numeric", year: "numeric" })})`;
      }
      return line;
    })
    .join("\n");
}
```

Replace the MEMORY INSTRUCTIONS block (lines ~2549-2579) with:

```
MEMORY INSTRUCTIONS:
You can automatically remember facts about the user. When you notice something worth remembering (preferences, name, job, habits, important dates, etc.), include this tag in your response — it will be saved and removed before delivery:

[REMEMBER: concise fact about the user]

Keep facts very concise (under 15 words each). Only remember genuinely useful things.

To remove an outdated or wrong fact or memory:
[FORGET: search text matching the entry to remove]

GOALS:
You can track goals for the user. When the user mentions a goal, objective, or something they want to achieve:

[GOAL: concise description of the goal]

To set a goal with a deadline (use ISO date format):
[GOAL: description | DEADLINE: YYYY-MM-DD]

When a goal is accomplished, mark it done:
[DONE: search text matching the goal]

To trigger a voice reply:
[VOICE_REPLY]

SCHEDULING:
You can create scheduled tasks that will run automatically. Include this tag in your response:

[CRON: <schedule> | <prompt>]

Schedule formats:
- Cron: "0 9 * * *" (5-field, e.g., daily at 9am)
- Interval: "every 2h" or "every 30m" (recurring)
- One-shot: "in 20m" or "in 1h" (runs once then auto-disables)

Examples:
[CRON: 0 9 * * 1 | check project deadlines and report status]
[CRON: every 4h | check if user has any pending reminders]
[CRON: in 30m | remind user about the meeting]

Use this when the user asks you to remind them of something, schedule periodic checks, or when you identify something that should be monitored regularly. The tag will be removed before delivery.
```

**3b. Update heartbeat prompt builder (line ~1251):**

Replace:
```typescript
const globalMemory = await getGlobalMemory();
```
With:
```typescript
const memoryFacts = await getMemoryContext();
const activeGoals = await getActiveGoals();
```

Update the tags instruction line (~1268) from:
```
- You may use these tags: [LEARN: fact] [FORGET: search text] [CRON: <schedule> | <prompt>]
```
To:
```
- You may use these tags: [REMEMBER: fact] [FORGET: search text] [GOAL: goal] [DONE: goal text] [CRON: <schedule> | <prompt>]
```

Update the memory section (line ~1276-1279) to include both facts and goals:
```typescript
if (memoryFacts.length > 0) {
  prompt += "\n\nTHINGS I KNOW ABOUT THE USER:\n";
  prompt += memoryFacts.map((m: string) => `- ${m}`).join("\n");
}

if (activeGoals.length > 0) {
  prompt += "\n\nACTIVE GOALS:\n";
  prompt += activeGoals
    .map((g) => {
      let line = `- ${g.content}`;
      if (g.deadline) {
        const d = new Date(g.deadline);
        line += ` (deadline: ${d.toLocaleDateString("en-US", { month: "short", day: "numeric", year: "numeric" })})`;
      }
      return line;
    })
    .join("\n");
}
```

**3c. Update cron job prompt builder (line ~801):**

Replace:
```typescript
const globalMemory = await getGlobalMemory();
```
With:
```typescript
const memoryFacts = await getMemoryContext();
const activeGoals = await getActiveGoals();
```

Update the memory section (line ~813-817) to include both:
```typescript
if (memoryFacts.length > 0) {
  prompt += "THINGS I KNOW ABOUT THE USER:\n";
  prompt += memoryFacts.map((m) => `- ${m}`).join("\n");
  prompt += "\n\n";
}

if (activeGoals.length > 0) {
  prompt += "ACTIVE GOALS:\n";
  prompt += activeGoals
    .map((g) => {
      let line = `- ${g.content}`;
      if (g.deadline) {
        const d = new Date(g.deadline);
        line += ` (deadline: ${d.toLocaleDateString("en-US", { month: "short", day: "numeric", year: "numeric" })})`;
      }
      return line;
    })
    .join("\n");
  prompt += "\n\n";
}
```

**3d. Update summary prompt (line ~2048):**

Change the instruction from:
```
Do NOT include any tags like [LEARN:] or [FORGET:].
```
To:
```
Do NOT include any tags like [REMEMBER:] or [FORGET:].
```
  </action>
  <verify>
Verify prompt builders:
1. No `[LEARN:]` string remains anywhere in the file (grep the entire file)
2. Main buildPrompt contains `[REMEMBER:` in instructions
3. Main buildPrompt contains `[GOAL:` in instructions
4. Main buildPrompt contains `[DONE:` in instructions
5. Main buildPrompt fetches `getMemoryContext()` AND `getActiveGoals()`
6. Main buildPrompt includes "ACTIVE GOALS:" section when goals exist
7. Heartbeat prompt includes `[REMEMBER:` not `[LEARN:` in tag list
8. Heartbeat prompt fetches both facts and goals
9. Cron prompt builder fetches both facts and goals
10. Summary prompt references `[REMEMBER:]` not `[LEARN:]`
  </verify>
  <done>All three prompt builders updated with new intent instructions, renamed tags, and active goals context. No LEARN references remain.</done>
</task>

<task type="auto">
  <name>Task 4: Update /memory command to show facts and goals separately</name>
  <files>src/relay.ts</files>
  <action>
Replace the `/memory` command handler (line ~2102-2116) with a version that separates facts from active goals.

Replace the entire handler body:

```typescript
bot.command("memory", async (ctx) => {
  const facts = await getMemoryContext();
  const goals = await getActiveGoals();

  if (facts.length === 0 && goals.length === 0) {
    await ctx.reply(
      "No memories stored yet. I'll learn facts about you as we chat."
    );
    return;
  }

  let text = "";

  if (facts.length > 0) {
    text += `Facts (${facts.length}):\n\n`;
    text += facts.map((m, i) => `${i + 1}. ${m}`).join("\n");
  }

  if (goals.length > 0) {
    if (text) text += "\n\n";
    text += `Active Goals (${goals.length}):\n\n`;
    text += goals
      .map((g, i) => {
        let line = `${i + 1}. ${g.content}`;
        if (g.deadline) {
          const d = new Date(g.deadline);
          line += ` (deadline: ${d.toLocaleDateString("en-US", { month: "short", day: "numeric", year: "numeric" })})`;
        }
        return line;
      })
      .join("\n");
  }

  text += "\n\nTo remove a memory, ask me to forget it. To complete a goal, tell me it's done.";

  await sendResponse(ctx, text);
});
```
  </action>
  <verify>
Verify /memory command:
1. Handler calls `getMemoryContext()` (not `getGlobalMemory()`)
2. Handler calls `getActiveGoals()`
3. Facts displayed under "Facts (N):" heading
4. Goals displayed under "Active Goals (N):" heading
5. Goals include deadline when present
6. Empty state message still works (no facts and no goals)
7. Footer text mentions both forgetting and completing
  </verify>
  <done>/memory command now shows facts and active goals in separate sections with deadlines.</done>
</task>

</tasks>

<verification>
Phase 15 verification checks mapped to requirements:

1. **R2 (Goals Lifecycle):**
   - `[GOAL: text]` creates entries with type='goal' in global_memory
   - `[GOAL: text | DEADLINE: date]` parses and stores deadline as TIMESTAMPTZ
   - `[DONE: search text]` finds matching goal and sets type='completed_goal' + completed_at
   - Active goals shown in all prompt contexts (main, heartbeat, cron)

2. **R3 (Rename LEARN → REMEMBER):**
   - `[LEARN:]` regex removed from processIntents()
   - `[REMEMBER:]` regex added
   - buildPrompt instructions say `[REMEMBER:]` not `[LEARN:]`
   - Heartbeat prompt says `[REMEMBER:]` not `[LEARN:]`
   - No `[LEARN:]` string anywhere in relay.ts

3. **R4 (Add GOAL Intent):**
   - `[GOAL:]` regex in processIntents() handles both simple and deadline variants
   - Calls insertMemory with type='goal'
   - Security: capped at 200 chars

4. **R5 (Add DONE Intent):**
   - `[DONE:]` regex in processIntents()
   - Calls completeGoal() which updates type to 'completed_goal' and sets completed_at
   - Logs success/failure

5. **R6 (Keep FORGET Intent):**
   - `[FORGET:]` regex unchanged in processIntents()
   - deleteMemory() (renamed from deleteGlobalMemory) preserves exact same logic

6. **R11 (Updated /memory Command):**
   - Facts shown under "Facts (N):" heading
   - Active goals shown under "Active Goals (N):" heading
   - Deadlines displayed when present
   - Footer instructs user on forget/complete actions
</verification>

<success_criteria>
- Zero references to `[LEARN:]` in relay.ts (tag fully replaced by `[REMEMBER:]`)
- Zero references to `getGlobalMemory`, `insertGlobalMemory`, `deleteGlobalMemory` (all renamed)
- processIntents() handles 5 intent types: REMEMBER, GOAL, DONE, FORGET, CRON
- insertMemory() accepts type parameter (default 'fact')
- getMemoryContext() calls get_facts() RPC
- getActiveGoals() calls get_active_goals() RPC
- completeGoal() updates matching goal to completed_goal type
- All 3 prompt builders show "ACTIVE GOALS:" section when goals exist
- /memory shows facts and goals in separate sections
- `bun build src/relay.ts --no-bundle` succeeds with no errors
</success_criteria>

<output>
After completion, create `.planning/phases/15-intent-system-upgrade/15-01-SUMMARY.md`
</output>
