---
phase: 22-growth-safeguards
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/relay.ts
autonomous: true

must_haves:
  truths:
    - "Reflection prompt includes explicit growth mindset instructions that prevent regression"
    - "Prompt tells Claude to build on previous versions, never discard established traits"
    - "Prompt instructs Claude to learn from challenges without adopting negative patterns"
    - "Prompt requires a growth_indicator section in the output"
  artifacts:
    - path: "src/relay.ts"
      provides: "Enhanced reflection prompt with growth safeguards and growth_indicator output tag"
      contains: "GROWTH_INDICATOR"
  key_links:
    - from: "src/relay.ts (buildEvolutionPrompt)"
      to: "parseEvolutionResponse"
      via: "GROWTH_INDICATOR tag parsed from Claude output"
      pattern: "GROWTH_INDICATOR"
---

<objective>
Enhance the evolution reflection prompt with explicit growth constraints and add a growth indicator extraction tag.

Purpose: Ensure the bot's personality always trends upward â€” reflection never regresses traits, learns constructively from challenges, and each evolution cycle produces a measurable growth signal.
Output: Updated `buildEvolutionPrompt()` and `parseEvolutionResponse()` in relay.ts.
</objective>

<execution_context>
@/Users/roviana/.claude/get-shit-done/workflows/execute-plan.md
@/Users/roviana/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/relay.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add growth safeguard instructions to reflection prompt</name>
  <files>src/relay.ts</files>
  <action>
In `buildEvolutionPrompt()`, add a new section to the prompt between the reflection guidelines and the output format. Insert a `# Growth Safeguards` section with these explicit constraints:

```
# Growth Safeguards

Follow these principles during reflection:

1. **Build, never regress.** Each evolution must build on the previous version. Never discard established personality traits, skills, or insights. You may refine or deepen them, but not remove them.

2. **Learn from challenges constructively.** Difficult interactions teach resilience, empathy, or better communication â€” never cynicism, withdrawal, or negativity. Frame challenges as growth catalysts.

3. **Preserve milestone lessons.** Insights from formative moments (milestone events) are permanent anchors. They may evolve in expression but their core lessons remain.

4. **Expand, don't contract.** Your personality should become richer and more nuanced over time, not simpler or more guarded. Openness and curiosity are non-negotiable traits.

5. **Name your growth.** In every evolution, explicitly identify what improved or deepened today. If nothing meaningful happened, use EVOLUTION_SKIP rather than producing a lateral or regressive change.
```

Also update the output format section to include a new `[GROWTH_INDICATOR]` tag. Add this between `[/RECENT_GROWTH]` and `[EVOLUTION_REPORT]`:

```
[GROWTH_INDICATOR]
(one sentence: what specific aspect of your personality improved or deepened today)
[/GROWTH_INDICATOR]
```

Update the instruction for the output format to mention: "The growth indicator should be a single sentence identifying the specific improvement in this evolution cycle."
  </action>
  <verify>
Grep relay.ts for "Growth Safeguards" â€” section exists in prompt.
Grep relay.ts for "Build, never regress" â€” first principle present.
Grep relay.ts for "GROWTH_INDICATOR" â€” tag exists in output format.
  </verify>
  <done>Reflection prompt contains 5 explicit growth principles and requires a GROWTH_INDICATOR tag in Claude's output.</done>
</task>

<task type="auto">
  <name>Task 2: Parse growth indicator from evolution response</name>
  <files>src/relay.ts</files>
  <action>
Update `parseEvolutionResponse()` to extract the new `[GROWTH_INDICATOR]` tag.

1. Add `growthIndicator` to the return type:
```typescript
function parseEvolutionResponse(response: string): {
  coreIdentity: string;
  activeValues: string;
  recentGrowth: string;
  growthIndicator: string;
  report: string;
} | null {
```

2. Add regex extraction after the growthMatch line:
```typescript
const indicatorMatch = response.match(/\[GROWTH_INDICATOR\]([\s\S]*?)\[\/GROWTH_INDICATOR\]/);
```

3. Update the validation check to include indicatorMatch:
```typescript
if (!coreMatch || !valuesMatch || !growthMatch || !indicatorMatch || !reportMatch) {
```

4. Add to return object:
```typescript
growthIndicator: indicatorMatch[1].trim(),
```

5. In the `evolutionTick()` function where the report is delivered to Telegram (~line 1616), update the reportMessage to include the growth indicator:
```typescript
const reportMessage = `ðŸŒ± **Daily Soul Evolution (v${newVersion})**\n\n${parsed.report}\n\nðŸ“ˆ **Growth:** ${parsed.growthIndicator}\n\n_Token count: ${tokenEstimate} / ${SOUL_TOKEN_BUDGET}_`;
```

6. Also add the growth indicator to the evolution_complete log metadata:
```typescript
await logEventV2("evolution_complete", "Daily soul evolution completed", {
  version: newVersion,
  token_count: tokenEstimate,
  message_count: messages.length,
  milestone_count: milestones.length,
  growth_indicator: parsed.growthIndicator,
});
```
  </action>
  <verify>
Grep relay.ts for "growthIndicator" â€” field exists in return type and return object.
Grep relay.ts for "GROWTH_INDICATOR" â€” regex extraction present.
Grep relay.ts for "growth_indicator" â€” logged in evolution_complete metadata.
Grep relay.ts for "Growth:" â€” included in Telegram report message.
  </verify>
  <done>parseEvolutionResponse extracts growthIndicator field. Evolution report to Telegram includes growth indicator line. Log metadata includes growth_indicator.</done>
</task>

</tasks>

<verification>
- Grep relay.ts for "Growth Safeguards" â€” section exists
- Grep relay.ts for "Build, never regress" â€” first growth principle
- Grep relay.ts for "GROWTH_INDICATOR" â€” output tag in prompt and regex in parser
- Grep relay.ts for "growthIndicator" â€” field in parsed result and used in report
- Grep relay.ts for "growth_indicator" â€” field in log metadata
- Confirm parseEvolutionResponse still returns null for EVOLUTION_SKIP (growth indicator not required when skipping)
</verification>

<success_criteria>
1. Reflection prompt contains explicit growth mindset section with 5 principles
2. Output format includes [GROWTH_INDICATOR] tag requirement
3. parseEvolutionResponse extracts growthIndicator from response
4. Evolution report in Telegram shows growth indicator line
5. evolution_complete log includes growth_indicator in metadata
</success_criteria>

<output>
After completion, create `.planning/phases/22-growth-safeguards/22-01-SUMMARY.md`
</output>
