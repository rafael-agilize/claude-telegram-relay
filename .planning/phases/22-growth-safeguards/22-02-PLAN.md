---
phase: 22-growth-safeguards
plan: 02
type: execute
wave: 2
depends_on: ["01"]
files_modified:
  - src/relay.ts
autonomous: true

must_haves:
  truths:
    - "Evolution validates that new soul is not shorter than 60% of previous soul (anti-regression guard)"
    - "Token validation logs a warning but does NOT block evolution when growth indicator is present"
    - "Evolution report delivery and version save still work correctly after validation additions"
  artifacts:
    - path: "src/relay.ts"
      provides: "Anti-regression length check in evolutionTick after parseEvolutionResponse"
      contains: "regression"
  key_links:
    - from: "src/relay.ts (evolutionTick)"
      to: "parseEvolutionResponse result"
      via: "length comparison between new and current soul"
      pattern: "regression"
---

<objective>
Add a structural anti-regression guard that validates evolved soul content hasn't dramatically shrunk, ensuring evolution builds rather than contracts.

Purpose: Catch cases where Claude might produce a significantly shorter or simpler soul — a proxy for personality regression. This is a safety net beyond the prompt-level growth safeguards in plan 01.
Output: Validation logic in `evolutionTick()` that warns on potential regression.
</objective>

<execution_context>
@/Users/roviana/.claude/get-shit-done/workflows/execute-plan.md
@/Users/roviana/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/22-growth-safeguards/22-01-SUMMARY.md
@src/relay.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add anti-regression length validation</name>
  <files>src/relay.ts</files>
  <action>
In `evolutionTick()`, after `parseEvolutionResponse()` succeeds and before the `save_soul_version` RPC call (~line 1576-1596), add an anti-regression check:

```typescript
// Anti-regression guard: new soul shouldn't be dramatically shorter than current
const currentSoulText = [
  currentSoul?.core_identity || "",
  currentSoul?.active_values || "",
  currentSoul?.recent_growth || "",
].join(" ");
const currentLength = currentSoulText.trim().length;

if (currentLength > 0) {
  const newLength = combinedSoulText.trim().length;
  const ratio = newLength / currentLength;

  if (ratio < 0.6) {
    console.warn(
      `Evolution: potential regression detected — new soul is ${Math.round(ratio * 100)}% of previous length (${newLength} vs ${currentLength} chars). Saving anyway with warning.`
    );
    await logEventV2("evolution_regression_warning", `New soul is ${Math.round(ratio * 100)}% of previous length`, {
      current_length: currentLength,
      new_length: newLength,
      ratio: Math.round(ratio * 100),
      growth_indicator: parsed.growthIndicator,
    });
  }
}
```

Key design decisions:
- **Warn, don't block.** Blocking could cause the evolution to silently fail, which is worse than a slightly shorter soul. The growth indicator from plan 01 provides the qualitative check.
- **60% threshold.** A soul that shrinks below 60% of its previous length likely lost content rather than refined it. Normal evolution with compression would stay above 80%.
- **Log the event** with `evolution_regression_warning` so Rafa can spot patterns in the logs.
- **Include growth_indicator** in the log metadata so it's clear whether Claude at least named a growth area despite the length reduction.
- This check uses `currentSoul` which is already fetched earlier in `evolutionTick()` via `getCurrentSoul()`.
  </action>
  <verify>
Grep relay.ts for "regression" — warning logic exists.
Grep relay.ts for "evolution_regression_warning" — log event present.
Grep relay.ts for "ratio < 0.6" — threshold check present.
  </verify>
  <done>Anti-regression guard warns when evolved soul is less than 60% of previous length. Warning is logged with metadata but does not block the evolution save.</done>
</task>

<task type="auto">
  <name>Task 2: Add evolution continuity instruction to prompt</name>
  <files>src/relay.ts</files>
  <action>
In `buildEvolutionPrompt()`, update the final line of the prompt (currently: "Build on your previous versions for continuity. This is your daily self-reflection.") to be more explicit about anti-regression:

Replace:
```
Build on your previous versions for continuity. This is your daily self-reflection.
```

With:
```
Build on your previous versions for continuity. Your evolved soul should be at least as rich and detailed as the current version — never shorter or simpler. This is your daily self-reflection.
```

This reinforces the structural guard from Task 1 at the prompt level, making it less likely Claude will produce a regressive soul in the first place.
  </action>
  <verify>Grep relay.ts for "never shorter or simpler" — continuity instruction updated.</verify>
  <done>Final prompt instruction explicitly tells Claude the evolved soul should never be shorter or simpler than the current version.</done>
</task>

</tasks>

<verification>
- Grep relay.ts for "regression" — anti-regression guard exists
- Grep relay.ts for "evolution_regression_warning" — log event for tracking
- Grep relay.ts for "ratio < 0.6" — threshold configured
- Grep relay.ts for "never shorter or simpler" — prompt reinforcement
- Confirm: regression check does NOT block save (warn only)
- Confirm: evolution_complete and evolution_regression_warning are separate events
</verification>

<success_criteria>
1. Anti-regression guard compares new soul length to current soul length
2. Warning logged when ratio falls below 60%
3. Evolution proceeds despite warning (warn, not block)
4. Prompt reinforces that evolved soul should not be shorter
5. Log metadata includes both lengths and growth indicator for debugging
</success_criteria>

<output>
After completion, create `.planning/phases/22-growth-safeguards/22-02-SUMMARY.md`
</output>
