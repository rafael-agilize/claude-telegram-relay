---
phase: 18-prompt-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [src/relay.ts]
autonomous: true

must_haves:
  truths:
    - "buildPrompt() injects 3-layer soul (Core Identity + Active Values + Recent Growth) in structured format"
    - "Cron job and heartbeat prompts use the same 3-layer soul structure"
    - "Full soul history and milestones are never loaded into any prompt"
    - "When no soul version exists, falls back to flat bot_soul content gracefully"
  artifacts:
    - path: "src/relay.ts"
      provides: "getCurrentSoul() RPC caller, formatSoulForPrompt() formatter, refactored buildPrompt/cron/heartbeat"
      contains: "get_current_soul"
  key_links:
    - from: "getCurrentSoul()"
      to: "get_current_soul RPC"
      via: "supabase.rpc('get_current_soul')"
      pattern: "supabase\\.rpc\\(['\"]get_current_soul['\"]"
    - from: "formatSoulForPrompt()"
      to: "buildPrompt()"
      via: "function call"
      pattern: "formatSoulForPrompt"
    - from: "formatSoulForPrompt()"
      to: "executeCronJob()"
      via: "function call replacing getActiveSoul()"
      pattern: "formatSoulForPrompt"
---

<objective>
Replace flat soul injection in all prompt-building code with structured 3-layer soul format from soul_versions table.

Purpose: Every Claude interaction should use the compressed 3-layer soul (Core Identity + Active Values + Recent Growth) instead of a flat text blob, enabling the personality evolution system in later phases.

Output: Modified src/relay.ts with getCurrentSoul(), formatSoulForPrompt(), and refactored prompt assembly in buildPrompt(), executeCronJob(), and heartbeatTick().
</objective>

<execution_context>
@/Users/roviana/.claude/get-shit-done/workflows/execute-plan.md
@/Users/roviana/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/17-three-layer-soul-schema/17-02-SUMMARY.md
@src/relay.ts
@examples/supabase-schema-v2.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add getCurrentSoul() and formatSoulForPrompt() helpers</name>
  <files>src/relay.ts</files>
  <action>
Add two new functions near the existing `getActiveSoul()` function (around line 495):

**getCurrentSoul()** — Fetches 3-layer soul from Supabase RPC:
```typescript
interface SoulVersion {
  id: string;
  version: number;
  core_identity: string;
  active_values: string;
  recent_growth: string;
  token_count: number;
  created_at: string;
}

async function getCurrentSoul(): Promise<SoulVersion | null> {
  if (!supabase) return null;
  try {
    const { data, error } = await supabase.rpc("get_current_soul");
    if (error || !data || data.length === 0) return null;
    return data[0] as SoulVersion;
  } catch (e) {
    console.error("getCurrentSoul error:", e);
    return null;
  }
}
```

**formatSoulForPrompt()** — Formats 3-layer soul or falls back to flat soul:
```typescript
async function formatSoulForPrompt(): Promise<string> {
  // Try 3-layer soul first (from soul_versions table)
  const soulVersion = await getCurrentSoul();
  if (soulVersion) {
    let parts: string[] = [];
    if (soulVersion.core_identity) {
      parts.push(`## Core Identity\n${soulVersion.core_identity}`);
    }
    if (soulVersion.active_values) {
      parts.push(`## Active Values\n${soulVersion.active_values}`);
    }
    if (soulVersion.recent_growth) {
      parts.push(`## Recent Growth\n${soulVersion.recent_growth}`);
    }
    if (parts.length > 0) {
      return parts.join("\n\n");
    }
  }
  // Fallback to flat bot_soul (for pre-evolution state or empty soul_versions)
  return await getActiveSoul();
}
```

Key behavior:
- `getCurrentSoul()` calls the `get_current_soul` RPC created in Phase 17-02
- `formatSoulForPrompt()` tries 3-layer first, falls back to flat `getActiveSoul()` if no soul_versions exist
- The seed migration (Phase 17-01) only populated core_identity, so active_values/recent_growth may be empty — skip empty layers in output
- Do NOT load reflection_notes, soul history, or milestones — those stay in the database (PROMPT-03)

Do NOT remove `getActiveSoul()` or `setSoul()` — they are still used by the `/soul` command and as fallback.
  </action>
  <verify>
Grep for `getCurrentSoul` and `formatSoulForPrompt` in relay.ts — both functions should exist. Grep for `get_current_soul` to confirm RPC call. Verify `getActiveSoul` still exists (not removed).
  </verify>
  <done>getCurrentSoul() calls get_current_soul RPC and returns SoulVersion. formatSoulForPrompt() returns structured 3-layer text or falls back to flat soul. Neither function loads history or milestones.</done>
</task>

<task type="auto">
  <name>Task 2: Refactor all soul injection points to use formatSoulForPrompt()</name>
  <files>src/relay.ts</files>
  <action>
There are 3 places that call `getActiveSoul()` for prompt construction. Refactor each:

**1. buildPrompt() (~line 2766)**
Replace:
```typescript
const soul = await getActiveSoul();
```
With:
```typescript
const soul = await formatSoulForPrompt();
```
The rest of the prompt assembly stays the same — soul text is injected at the top.

**2. executeCronJob() (~line 898)**
Replace:
```typescript
const soul = await getActiveSoul();
```
With:
```typescript
const soul = await formatSoulForPrompt();
```

**3. heartbeatTick() (~line 1364)**
Replace:
```typescript
const soul = await getActiveSoul();
```
With:
```typescript
const soul = await formatSoulForPrompt();
```
The heartbeat places soul AFTER task instructions with the "YOUR PERSONALITY" wrapper — keep that behavior unchanged.

Do NOT modify the `/soul` command handler (~line 2297) — it still reads/writes flat `bot_soul` table via `getActiveSoul()`/`setSoul()`. That's correct: `/soul` sets the seed personality, evolution creates soul_versions on top of it.

After refactoring, the only remaining callers of `getActiveSoul()` should be:
- `formatSoulForPrompt()` (fallback path)
- `/soul` command handler (display current flat soul)
  </action>
  <verify>
Grep for `getActiveSoul()` — should appear in: formatSoulForPrompt (fallback), setSoul, /soul command handler, and its own definition. Should NOT appear in buildPrompt, executeCronJob, or heartbeatTick. Grep for `formatSoulForPrompt()` — should appear in buildPrompt, executeCronJob, heartbeatTick.
  </verify>
  <done>All 3 prompt-building functions (buildPrompt, executeCronJob, heartbeatTick) use formatSoulForPrompt() instead of getActiveSoul(). The /soul command still uses getActiveSoul()/setSoul() directly.</done>
</task>

</tasks>

<verification>
1. `getCurrentSoul` function exists and calls `supabase.rpc("get_current_soul")`
2. `formatSoulForPrompt` function exists with 3-layer formatting and flat fallback
3. `buildPrompt()` calls `formatSoulForPrompt()` not `getActiveSoul()`
4. `executeCronJob()` calls `formatSoulForPrompt()` not `getActiveSoul()`
5. `heartbeatTick()` calls `formatSoulForPrompt()` not `getActiveSoul()`
6. `getActiveSoul()` still exists (used by /soul command and as fallback)
7. No calls to `get_soul_history`, `get_milestone_moments`, or `reflection_notes` in prompt code
</verification>

<success_criteria>
- All Claude interactions (chat, cron, heartbeat) use 3-layer soul structure when soul_versions exist
- Graceful fallback to flat bot_soul when no soul_versions in table
- Soul history and milestones never loaded into any prompt
- `/soul` command continues to work for viewing/setting flat personality
</success_criteria>

<output>
After completion, create `.planning/phases/18-prompt-integration/18-01-SUMMARY.md`
</output>
