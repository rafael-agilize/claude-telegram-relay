---
phase: 18-prompt-integration
plan: 02
type: execute
wave: 2
depends_on: ["18-01"]
files_modified: [src/relay.ts]
autonomous: true

must_haves:
  truths:
    - "Active soul text in prompt never exceeds 800 tokens"
    - "Token count is estimated before prompt assembly and logged if over budget"
    - "Over-budget soul is truncated gracefully, not rejected"
  artifacts:
    - path: "src/relay.ts"
      provides: "estimateTokens() helper, token validation in formatSoulForPrompt()"
      contains: "estimateTokens"
  key_links:
    - from: "estimateTokens()"
      to: "formatSoulForPrompt()"
      via: "called before returning formatted soul"
      pattern: "estimateTokens"
---

<objective>
Add token counting validation to ensure the active soul text injected into prompts never exceeds 800 tokens.

Purpose: Enforces the token budget constraint (PROMPT-02) to keep personality injection lightweight. Prevents runaway soul evolution from bloating the context window.

Output: Modified src/relay.ts with estimateTokens() helper and truncation logic in formatSoulForPrompt().
</objective>

<execution_context>
@/Users/roviana/.claude/get-shit-done/workflows/execute-plan.md
@/Users/roviana/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/18-prompt-integration/18-01-SUMMARY.md
@src/relay.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add estimateTokens() helper and token validation in formatSoulForPrompt()</name>
  <files>src/relay.ts</files>
  <action>
Add a lightweight token estimation function near the soul-related helpers:

```typescript
const SOUL_TOKEN_BUDGET = 800;

function estimateTokens(text: string): number {
  // Approximation: ~1.3 tokens per word for English text
  // This avoids adding a tokenizer dependency
  return Math.ceil(text.split(/\s+/).filter(Boolean).length * 1.3);
}
```

Then update `formatSoulForPrompt()` to validate and truncate if over budget:

After assembling the 3-layer soul text (the `parts.join("\n\n")` result), add:

```typescript
const soulText = parts.join("\n\n");
const tokenEstimate = estimateTokens(soulText);

if (tokenEstimate > SOUL_TOKEN_BUDGET) {
  console.warn(`Soul token estimate ${tokenEstimate} exceeds budget ${SOUL_TOKEN_BUDGET}, truncating`);
  // Truncate by removing Recent Growth first (most ephemeral), then Active Values
  // Core Identity is never truncated — it's the most stable layer
  if (soulVersion.recent_growth) {
    parts = parts.filter(p => !p.startsWith("## Recent Growth"));
    const reduced = parts.join("\n\n");
    if (estimateTokens(reduced) <= SOUL_TOKEN_BUDGET) {
      return reduced;
    }
  }
  if (soulVersion.active_values) {
    parts = parts.filter(p => !p.startsWith("## Active Values"));
    const reduced = parts.join("\n\n");
    if (estimateTokens(reduced) <= SOUL_TOKEN_BUDGET) {
      return reduced;
    }
  }
  // If still over budget with just Core Identity, hard-truncate at word boundary
  const coreOnly = soulVersion.core_identity;
  const words = coreOnly.split(/\s+/);
  const maxWords = Math.floor(SOUL_TOKEN_BUDGET / 1.3);
  return "## Core Identity\n" + words.slice(0, maxWords).join(" ");
}

return soulText;
```

Key design decisions:
- Use word-count * 1.3 approximation (no new dependency needed, consistent with project's lightweight approach)
- Truncation priority: remove Recent Growth first (most ephemeral), then Active Values, then hard-truncate Core Identity
- Log a warning when truncation happens — visible in relay.log for debugging
- The constant `SOUL_TOKEN_BUDGET = 800` is defined at module level for easy tuning
- The `token_count` column in soul_versions stores the actual count from generation time (Phase 19), but we validate at injection time too as a safety net
  </action>
  <verify>
Grep for `estimateTokens` — function should exist. Grep for `SOUL_TOKEN_BUDGET` — constant should be 800. Grep for `exceeds budget` — truncation warning should exist. Verify formatSoulForPrompt contains the truncation logic.
  </verify>
  <done>estimateTokens() estimates token count. formatSoulForPrompt() validates against 800-token budget, truncates layers bottom-up (Recent Growth -> Active Values -> Core Identity hard-truncate) when over budget, and logs a warning.</done>
</task>

</tasks>

<verification>
1. `SOUL_TOKEN_BUDGET` constant equals 800
2. `estimateTokens()` function exists and uses word-based approximation
3. `formatSoulForPrompt()` calls `estimateTokens()` and truncates if over budget
4. Truncation priority: Recent Growth removed first, then Active Values, then Core Identity hard-truncated
5. Warning logged when truncation occurs
</verification>

<success_criteria>
- Active soul text in prompt never exceeds ~800 tokens
- Truncation is graceful (removes least important layers first)
- No new dependencies added (word-based token estimation)
- Truncation events are logged for observability
</success_criteria>

<output>
After completion, create `.planning/phases/18-prompt-integration/18-02-SUMMARY.md`
</output>
