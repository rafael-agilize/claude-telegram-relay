---
phase: 19-daily-evolution-engine
plan: 02
type: execute
wave: 2
depends_on: [19-01]
files_modified: [src/relay.ts]
autonomous: true

must_haves:
  truths:
    - "Evolution tick builds a reflection prompt with 24h messages and current soul"
    - "Claude generates new 3-layer soul text from reflection"
    - "New soul version is saved via save_soul_version RPC before any update"
    - "Evolution report is delivered to Rafa via Telegram (DM or heartbeat topic)"
    - "Generated soul respects ~800 token budget"
  artifacts:
    - path: "src/relay.ts"
      provides: "buildEvolutionPrompt(), performDailyEvolution(), evolution report delivery"
      contains: "buildEvolutionPrompt"
  key_links:
    - from: "performDailyEvolution()"
      to: "getLast24hMessages()"
      via: "function call for 24h interaction data"
      pattern: "getLast24hMessages"
    - from: "performDailyEvolution()"
      to: "supabase.rpc('save_soul_version')"
      via: "RPC call to persist new soul"
      pattern: "rpc.*save_soul_version"
    - from: "performDailyEvolution()"
      to: "sendHeartbeatToTelegram|bot.api.sendMessage"
      via: "Telegram notification delivery"
      pattern: "sendMessage|sendHeartbeatToTelegram"
    - from: "buildEvolutionPrompt()"
      to: "formatSoulForPrompt()"
      via: "current soul injection"
      pattern: "formatSoulForPrompt\\(\\)|getCurrentSoul"
---

<objective>
Implement the daily reflection logic: build prompt, call Claude, parse structured soul output, save new version, notify Rafa.

Purpose: This is the core of the daily evolution engine. The bot reflects on the day's interactions, generates a compressed 3-layer soul update, persists it, and sends Rafa an observer report.

Output: Complete daily evolution pipeline from data gathering to Telegram notification.
</objective>

<execution_context>
@/Users/roviana/.claude/get-shit-done/workflows/execute-plan.md
@/Users/roviana/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/19-daily-evolution-engine/19-01-SUMMARY.md
@src/relay.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build reflection prompt and Claude call with structured output parsing</name>
  <files>src/relay.ts</files>
  <action>
Add two functions near the evolution timer code:

1. `function buildEvolutionPrompt(currentSoul: SoulVersion | null, soulHistory: SoulVersion[], messages: Array<{ role: string; content: string; thread_name: string; created_at: string }>): string`

The prompt must instruct Claude to:
- Review the day's interactions (provided as context)
- Reflect on patterns, lessons, growth, and meaningful moments
- Generate an updated 3-layer soul in a STRICT format:
  ```
  [CORE_IDENTITY]
  (text)
  [/CORE_IDENTITY]
  [ACTIVE_VALUES]
  (text)
  [/ACTIVE_VALUES]
  [RECENT_GROWTH]
  (text)
  [/RECENT_GROWTH]
  [EVOLUTION_REPORT]
  (text — what changed and why, for Rafa to read)
  [/EVOLUTION_REPORT]
  ```
- Stay within ~800 tokens total for the 3 soul layers (mention this explicitly)
- Core Identity should be the most stable (rarely changes), Active Values evolve weekly, Recent Growth is ephemeral (daily)
- Build on previous versions for continuity (include current soul + last 2-3 versions as context)
- If no meaningful interactions happened, output `EVOLUTION_SKIP` instead

The prompt should include:
- Current 3-layer soul (formatted with headers)
- Recent soul history (version numbers + dates + content summary from getSoulHistory)
- Today's interactions grouped by thread name, with truncation strategy:
  - Sort all messages by `created_at ASC`, take the last 100 messages max.
  - Per message: include first 200 characters of content; if longer, append "..." (truncate).
  - Group by thread_name with headers like `## Thread: {name}`.
- Current date and time

2. `function parseEvolutionResponse(response: string): { coreIdentity: string; activeValues: string; recentGrowth: string; report: string } | null`

Parse the tagged sections from Claude's response. Return null if EVOLUTION_SKIP is present or if parsing fails. Use regex to extract content between `[CORE_IDENTITY]...[/CORE_IDENTITY]` etc. Trim whitespace from each section.
  </action>
  <verify>
Grep for `buildEvolutionPrompt` and `parseEvolutionResponse` in relay.ts. Verify the prompt includes instructions for all 4 tagged sections. Verify parser handles EVOLUTION_SKIP.
  </verify>
  <done>
Reflection prompt assembles 24h context + soul history and instructs Claude to output structured 3-layer soul. Parser extracts tagged sections or returns null for skip/error.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire performDailyEvolution() into evolutionTick with save + notify</name>
  <files>src/relay.ts</files>
  <action>
1. Add `async function performDailyEvolution(): Promise<void>`:
   - Call `getLast24hMessages()`. If empty (no interactions today), log "Evolution: no interactions in last 24h, skipping" and return.
   - Call `getCurrentSoul()` for current soul state.
   - Call `getSoulHistory(3)` for recent versions.
   - Build prompt via `buildEvolutionPrompt(currentSoul, soulHistory, messages)`.
   - Call Claude: `const { text } = await callClaude(prompt)` — no --resume, standalone call (like heartbeat).
   - Parse response via `parseEvolutionResponse(text)`.
   - If null (skip or parse failure), log and return.
   - Validate token budget: `estimateTokens(parsed.coreIdentity + parsed.activeValues + parsed.recentGrowth)` must be <= SOUL_TOKEN_BUDGET. Log warning if over but proceed (Claude was asked to stay within budget).
   - Save new version: `await supabase.rpc('save_soul_version', { p_core_identity: parsed.coreIdentity, p_active_values: parsed.activeValues, p_recent_growth: parsed.recentGrowth, p_reflection_notes: text, p_token_count: tokenEstimate })`. Log the new version number.
   - Log event: `await logEventV2('evolution_complete', 'Daily soul evolution completed', { version, token_count })`.
   - Deliver report to Telegram: Format the evolution report with a header like "Daily Soul Evolution (v{version})" and send via `sendHeartbeatToTelegram()` (reuses heartbeat topic delivery — evolution reports go to the same dedicated thread). If heartbeat topic unavailable, fall back to DM.

2. Update `evolutionTick()` (from Plan 01) to replace the placeholder log with:
   ```
   try {
     await performDailyEvolution();
   } catch (e) {
     console.error("Evolution error:", e);
     await logEventV2("evolution_error", String(e).substring(0, 200));
   }
   ```

3. Add event types to logEventV2 calls: `evolution_tick`, `evolution_skip`, `evolution_complete`, `evolution_error`.
  </action>
  <verify>
Grep for `performDailyEvolution`, `save_soul_version`, `evolution_complete` in relay.ts. Verify the function calls getLast24hMessages, getCurrentSoul, getSoulHistory, buildEvolutionPrompt, parseEvolutionResponse, callClaude, and save_soul_version RPC in correct order. Verify Telegram delivery happens after save.
  </verify>
  <done>
Full evolution pipeline works: gather data -> build prompt -> call Claude -> parse structured output -> save new soul version -> notify Rafa via Telegram. Skips gracefully when no interactions or Claude says EVOLUTION_SKIP.
  </done>
</task>

</tasks>

<verification>
1. `grep -n "buildEvolutionPrompt\|parseEvolutionResponse\|performDailyEvolution" src/relay.ts` — all 3 functions exist
2. `grep -n "save_soul_version" src/relay.ts` — RPC call present in performDailyEvolution
3. `grep -n "EVOLUTION_SKIP\|evolution_complete\|evolution_error" src/relay.ts` — skip handling and logging
4. `grep -n "sendHeartbeatToTelegram\|sendMessage" src/relay.ts | grep -i evol` — Telegram delivery wired
5. No syntax errors: `bun build src/relay.ts --no-bundle 2>&1 | head -5`
</verification>

<success_criteria>
- Reflection prompt includes 24h messages, current soul, and soul history
- Claude output is parsed into 3 distinct layers + evolution report
- New soul version is saved via save_soul_version RPC (old version preserved automatically)
- Evolution report delivered to Telegram (heartbeat topic or DM fallback)
- EVOLUTION_SKIP is handled gracefully (no save, no notification)
- Token budget validation logged when exceeded
</success_criteria>

<output>
After completion, create `.planning/phases/19-daily-evolution-engine/19-02-SUMMARY.md`
</output>
