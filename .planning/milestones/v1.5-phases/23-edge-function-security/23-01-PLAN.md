---
phase: 23-edge-function-security
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/functions/embed/index.ts
  - supabase/functions/search/index.ts
autonomous: true

must_haves:
  truths:
    - "Edge Functions reject requests without valid service_role JWT with 401"
    - "Error responses contain only generic messages, no internal details"
    - "Server-side logs retain full error details for debugging"
  artifacts:
    - path: "supabase/functions/embed/index.ts"
      provides: "JWT auth guard and sanitized error responses"
      contains: "authorization"
    - path: "supabase/functions/search/index.ts"
      provides: "JWT auth guard and sanitized error responses"
      contains: "authorization"
  key_links:
    - from: "supabase/functions/embed/index.ts"
      to: "Authorization header"
      via: "JWT verification before request processing"
      pattern: "authorization.*service_role"
    - from: "supabase/functions/search/index.ts"
      to: "Authorization header"
      via: "JWT verification before request processing"
      pattern: "authorization.*service_role"
---

<objective>
Add authentication guards and error sanitization to both Edge Functions.

Purpose: Prevent unauthenticated callers from invoking Edge Functions and stop internal error details from leaking to callers (EDGE-01, EDGE-04).
Output: Both Edge Functions verify service_role JWT and return generic error messages.
</objective>

<execution_context>
@/Users/roviana/.claude/get-shit-done/workflows/execute-plan.md
@/Users/roviana/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@supabase/functions/embed/index.ts
@supabase/functions/search/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add JWT auth guard to both Edge Functions</name>
  <files>supabase/functions/embed/index.ts, supabase/functions/search/index.ts</files>
  <action>
Add an authentication check at the top of each Edge Function's request handler (after the method check, before any body parsing).

The guard must:
1. Extract the `Authorization` header from the request
2. Verify it exists and starts with `Bearer `
3. Compare the token against `Deno.env.get("SUPABASE_SERVICE_ROLE_KEY")` — Supabase Edge Functions invoked via `supabase.functions.invoke()` automatically send the client's key as Bearer token. The relay uses the service_role key, so this is the expected token.
4. If missing or mismatched, return `401 Unauthorized` with body `{ "error": "Unauthorized" }` and `Content-Type: application/json` header
5. Log `console.warn("Unauthorized request to [embed|search] function")` for observability

Implementation pattern (add to both files after method check):
```typescript
const authHeader = req.headers.get("authorization");
if (!authHeader?.startsWith("Bearer ") || authHeader.split(" ")[1] !== Deno.env.get("SUPABASE_SERVICE_ROLE_KEY")) {
  console.warn("Unauthorized request to embed function");
  return new Response(
    JSON.stringify({ error: "Unauthorized" }),
    { status: 401, headers: { "Content-Type": "application/json" } }
  );
}
```

Note: Database webhook invocations (for the embed function) also carry the service_role key automatically when configured through the Supabase dashboard, so this guard works for both webhook and direct invocation paths.
  </action>
  <verify>
Read both files and confirm:
- Auth check exists before body parsing
- Returns 401 with generic error on auth failure
- Uses SUPABASE_SERVICE_ROLE_KEY for comparison
  </verify>
  <done>Both Edge Functions reject unauthenticated requests with 401 before any processing occurs.</done>
</task>

<task type="auto">
  <name>Task 2: Sanitize error responses in both Edge Functions</name>
  <files>supabase/functions/embed/index.ts, supabase/functions/search/index.ts</files>
  <action>
Replace all error responses that leak internal details with generic messages. Keep `console.error()` calls for server-side logging.

**embed/index.ts changes:**

1. Line ~57-59: OpenAI API error response — change from:
   `JSON.stringify({ error: "OpenAI API error", details: err })`
   To:
   `JSON.stringify({ error: "Embedding generation failed" })`
   Keep the `console.error("OpenAI API error:", err)` above it.

2. Line ~67-69: No embedding returned — change from:
   `JSON.stringify({ error: "No embedding returned from OpenAI" })`
   To:
   `JSON.stringify({ error: "Embedding generation failed" })`

3. Line ~80-82: Database update error — change from:
   `JSON.stringify({ error: "Database update failed", details: updateError.message })`
   To:
   `JSON.stringify({ error: "Processing failed" })`
   Keep the `console.error("Supabase update error:", updateError)` above it.

4. Line ~95: Catch-all error — change from:
   `JSON.stringify({ error: err instanceof Error ? err.message : "Unknown error" })`
   To:
   `JSON.stringify({ error: "Internal error" })`
   Keep the `console.error("Embed function error:", err)` above it.

**search/index.ts changes:**

1. Line ~48: OpenAI API error — change from:
   `JSON.stringify({ results: [], error: "OpenAI API error" })`
   To:
   `JSON.stringify({ results: [] })`
   (Remove the error field entirely — callers get empty results gracefully)

2. Line ~58: No embedding returned — change from:
   `JSON.stringify({ results: [], error: "No embedding returned" })`
   To:
   `JSON.stringify({ results: [] })`

3. Line ~73: match_memory RPC error — change from:
   `JSON.stringify({ results: [], error: error.message })`
   To:
   `JSON.stringify({ results: [] })`

4. Line ~85: Catch-all error — change from:
   `JSON.stringify({ results: [], error: err instanceof Error ? err.message : "Unknown error" })`
   To:
   `JSON.stringify({ results: [] })`

The search function already returns `{ results: [] }` on errors (graceful degradation pattern from CLAUDE.md). Removing the `error` field prevents leaking internal details while maintaining the same caller behavior.
  </action>
  <verify>
Read both files and confirm:
- No `details:` fields in any error response
- No `err.message` or `error.message` in any response body
- All `console.error()` calls preserved for server-side logging
- Search function returns only `{ results: [] }` on any error (no error field)
- Embed function returns generic error strings only
  </verify>
  <done>Error responses contain no internal details. Server-side logs retain full error context.</done>
</task>

</tasks>

<verification>
1. Read embed/index.ts — auth guard present before body parsing, all error responses are generic
2. Read search/index.ts — auth guard present before body parsing, all error responses are `{ results: [] }`
3. No `details:` key in any JSON response in either file
4. Both files log detailed errors via `console.error()` / `console.warn()`
</verification>

<success_criteria>
- Both Edge Functions return 401 for requests without valid service_role JWT
- No error response in either function contains internal error details
- Server-side console logging preserved for all error paths
</success_criteria>

<output>
After completion, create `.planning/phases/23-edge-function-security/23-01-SUMMARY.md`
</output>
