---
phase: 24-intent-injection-defense
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [src/relay.ts]
autonomous: true

must_haves:
  truths:
    - "processIntents() accepts a context parameter that controls which intents are processed"
    - "Heartbeat calls to processIntents() pass context 'heartbeat' and CRON/FORGET intents are silently dropped"
    - "Cron execution calls to processIntents() pass context 'cron' and CRON/FORGET intents are silently dropped"
    - "Interactive message handler calls to processIntents() pass context 'interactive' and all intents are processed"
    - "Dropped intents are logged but NOT executed and NOT included in the response"
  artifacts:
    - path: "src/relay.ts"
      provides: "Context-aware intent processing with allowlists"
      contains: "IntentContext"
  key_links:
    - from: "processIntents()"
      to: "heartbeatTick()"
      via: "context parameter 'heartbeat'"
      pattern: "processIntents.*heartbeat"
    - from: "processIntents()"
      to: "executeCronJob()"
      via: "context parameter 'cron'"
      pattern: "processIntents.*cron"
    - from: "processIntents()"
      to: "message handlers"
      via: "context parameter 'interactive'"
      pattern: "processIntents.*interactive"
---

<objective>
Add context-aware intent allowlists to processIntents() so heartbeat and cron execution contexts cannot create cron jobs or delete memories.

Purpose: Prevent prompt injection escalation where Claude responses in automated contexts (heartbeat, cron) could execute dangerous intents like CRON (self-replicating jobs) or FORGET (deleting user memories).
Output: processIntents() with context parameter and per-context allowlists enforced.
</objective>

<execution_context>
@/Users/roviana/.claude/get-shit-done/workflows/execute-plan.md
@/Users/roviana/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/relay.ts (lines 2084-2231 — processIntents function)
@src/relay.ts (lines 1267-1355 — executeCronJob function)
@src/relay.ts (lines 1439-1510 — heartbeatTick function)
@src/relay.ts (lines 3325-3500 — message handlers)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add IntentContext type and allowlist map to processIntents()</name>
  <files>src/relay.ts</files>
  <action>
1. Define a type alias near the top of the intent system section (around line 2084):
   ```typescript
   type IntentContext = 'interactive' | 'heartbeat' | 'cron';
   ```

2. Define the allowlist map as a constant (right after the type):
   ```typescript
   const INTENT_ALLOWLIST: Record<IntentContext, Set<string>> = {
     interactive: new Set(['REMEMBER', 'FORGET', 'GOAL', 'DONE', 'CRON', 'VOICE_REPLY', 'MILESTONE']),
     heartbeat: new Set(['REMEMBER', 'GOAL', 'DONE', 'VOICE_REPLY', 'MILESTONE']),
     cron: new Set(['REMEMBER', 'GOAL', 'DONE', 'VOICE_REPLY', 'MILESTONE']),
   };
   ```
   Note: heartbeat and cron EXCLUDE 'CRON' and 'FORGET'. This prevents:
   - Self-replicating cron jobs via [CRON:] in automated contexts
   - Memory deletion via [FORGET:] in automated contexts

3. Change the processIntents() signature from:
   ```typescript
   async function processIntents(response: string, threadDbId?: string): Promise<string>
   ```
   to:
   ```typescript
   async function processIntents(response: string, threadDbId?: string, context: IntentContext = 'interactive'): Promise<string>
   ```

4. At the start of processIntents(), after the `hasIntents` log line, add:
   ```typescript
   const allowed = INTENT_ALLOWLIST[context];
   ```

5. Before each intent processing block, add a guard that checks if the intent is allowed. If not allowed, strip the tag but do NOT execute the action, and log a warning. For each intent block:

   - Before REMEMBER block: `if (!allowed.has('REMEMBER')) { /* strip tags only */ } else { /* existing code */ }`
   - Before GOAL block: same pattern with 'GOAL'
   - Before DONE block: same pattern with 'DONE'
   - Before FORGET block: same pattern with 'FORGET'
   - Before CRON block: same pattern with 'CRON'
   - Before MILESTONE block: same pattern with 'MILESTONE'

   The stripping logic for blocked intents: match all instances of the tag, strip them from `clean`, log:
   ```typescript
   console.warn(`[Intents] Blocked ${intentName} intent in '${context}' context`);
   ```

   Implementation approach — wrap each existing intent block in an if-else:
   ```typescript
   // [FORGET: ...] — only in interactive
   const forgetMatches = response.matchAll(/\[FORGET:\s*(.+?)\]/gi);
   for (const match of forgetMatches) {
     if (!allowed.has('FORGET')) {
       console.warn(`[Intents] Blocked FORGET intent in '${context}' context: ${match[1].trim().substring(0, 50)}`);
     } else {
       // ... existing FORGET processing logic ...
     }
     clean = clean.replace(match[0], "");
   }
   ```

   The key insight: the tag is ALWAYS stripped from the response (clean = clean.replace). The action is only executed when allowed. This means blocked intents are silently removed from the user-facing message.
  </action>
  <verify>
Search relay.ts for "IntentContext" — should find the type, the allowlist, and the parameter.
Search for "Blocked.*intent in" — should find guard log lines for FORGET and CRON at minimum.
Confirm processIntents signature includes `context: IntentContext = 'interactive'`.
  </verify>
  <done>processIntents() accepts an IntentContext parameter, defaults to 'interactive', and has per-intent guards that block execution but strip tags for disallowed intents in each context.</done>
</task>

<task type="auto">
  <name>Task 2: Pass context parameter from all processIntents() call sites</name>
  <files>src/relay.ts</files>
  <action>
Update every call site of processIntents() to pass the correct context:

1. **executeCronJob()** (around line 1347):
   Change: `await processIntents(text, threadInfo?.dbId)`
   To: `await processIntents(text, threadInfo?.dbId, 'cron')`

2. **heartbeatTick()** (around line 1498):
   Change: `await processIntents(rawResponse)`
   To: `await processIntents(rawResponse, undefined, 'heartbeat')`

3. **Text message handler** (around line 3335):
   Change: `await processIntents(rawResponse, ctx.threadInfo?.dbId)`
   To: `await processIntents(rawResponse, ctx.threadInfo?.dbId, 'interactive')`
   (Explicit for clarity, though 'interactive' is the default)

4. **Voice message handler** (around line 3393):
   Change: `await processIntents(rawResponse, ctx.threadInfo?.dbId)`
   To: `await processIntents(rawResponse, ctx.threadInfo?.dbId, 'interactive')`

5. **Photo message handler** (around line 3446):
   Change: `await processIntents(rawResponse, ctx.threadInfo?.dbId)`
   To: `await processIntents(rawResponse, ctx.threadInfo?.dbId, 'interactive')`

6. **Document message handler** (around line 3489):
   Change: `await processIntents(rawResponse, ctx.threadInfo?.dbId)`
   To: `await processIntents(rawResponse, ctx.threadInfo?.dbId, 'interactive')`

All 6 call sites must be updated. No call site should be left without an explicit context parameter.
  </action>
  <verify>
Search relay.ts for `processIntents(` — all 6 occurrences should have a third argument ('interactive', 'heartbeat', or 'cron').
Grep for `processIntents(.*'cron'` — should find exactly 1 match (executeCronJob).
Grep for `processIntents(.*'heartbeat'` — should find exactly 1 match (heartbeatTick).
Grep for `processIntents(.*'interactive'` — should find exactly 4 matches (text, voice, photo, document handlers).
  </verify>
  <done>All 6 processIntents() call sites pass explicit context: 4 interactive, 1 heartbeat, 1 cron. Heartbeat and cron contexts will have CRON and FORGET intents silently blocked.</done>
</task>

</tasks>

<verification>
1. `grep -n "IntentContext" src/relay.ts` — type, allowlist, and parameter usage visible
2. `grep -n "processIntents(" src/relay.ts` — all 6 call sites + declaration, all with explicit context
3. `grep -n "Blocked.*intent" src/relay.ts` — guard log lines present for blocked intents
4. `bun run start` succeeds without TypeScript errors (quick startup check, then Ctrl+C)
</verification>

<success_criteria>
- processIntents() accepts IntentContext parameter with 3 values: interactive, heartbeat, cron
- INTENT_ALLOWLIST constant defines per-context allowed intents
- Heartbeat context blocks CRON and FORGET intents (silently stripped, logged)
- Cron context blocks CRON and FORGET intents (silently stripped, logged)
- Interactive context allows all intents (unchanged behavior)
- All 6 call sites pass explicit context parameter
- No TypeScript compilation errors
</success_criteria>

<output>
After completion, create `.planning/phases/24-intent-injection-defense/24-01-SUMMARY.md`
</output>
