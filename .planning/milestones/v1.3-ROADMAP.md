# v1.3 — Smart Memory (Archived)

**Goal:** Evolve flat memory into typed system with goals tracking and semantic search, adapting upstream's memory module to our threaded architecture.

**Origin:** Upstream commit [fced316](https://github.com/rafael-agilize/claude-telegram-relay/commit/fced3162c65657635e97164f7ba4f519e145283a)

**Status:** Complete (3 phases, shipped 2026-02-13)

**Timeline:** 2026-02-13 (single day — Phases 14, 15, 16)

**Stats:** 5 commits, 934 insertions, 70 deletions, 9 files changed

## Phases

### Phase 14: Schema Migration & Typed Memory
**Goal:** Evolve `global_memory` table to support typed entries with embeddings.
**Requirements:** R1, R12, NF3
**Plans:** 1 plan
- [x] 14-01-PLAN.md — Migration SQL + reference schema update (columns, RPCs, extensions, backfill)

**Delivered:**
- Migration SQL: add `type`, `deadline`, `completed_at`, `priority`, `embedding` columns to `global_memory`
- Enable `vector` and `pg_net` extensions
- Create `match_memory()`, `get_facts()`, `get_active_goals()` RPCs
- Backfill existing rows as type `fact`
- Update reference schema (`examples/supabase-schema-v2.sql`)

### Phase 15: Intent System Upgrade
**Goal:** Rename tags to upstream convention and add goals lifecycle intents.
**Requirements:** R2, R3, R4, R5, R6, R11
**Plans:** 1 plan
- [x] 15-01-PLAN.md — Rename functions, update processIntents, prompt builders, /memory command

**Delivered:**
- Rename `[LEARN:]` → `[REMEMBER:]` in `processIntents()` and all `buildPrompt()` instructions
- Add `[GOAL: text]` and `[GOAL: text | DEADLINE: date]` intent parsing
- Add `[DONE: search text]` intent parsing (marks goal as completed)
- Keep `[FORGET:]` unchanged
- Update `/memory` command to show facts + active goals separately
- Rename functions: `insertGlobalMemory` → `insertMemory`, `deleteGlobalMemory` → `deleteMemory`, `getGlobalMemory` → `getMemoryContext`

### Phase 16: Semantic Search via Edge Functions
**Goal:** Add auto-embedding and semantic search powered by OpenAI embeddings in Supabase.
**Requirements:** R7, R8, R9, R10, NF1, NF2
**Plans:** 1 plan
- [x] 16-01-PLAN.md — Edge Functions (embed + search), relay integration (getRelevantMemory + buildPrompt), setup docs

**Delivered:**
- `supabase/functions/embed/index.ts` — auto-embed on INSERT via database webhook
- `supabase/functions/search/index.ts` — semantic search via query embedding + `match_memory()` RPC
- `getRelevantMemory(query)` function in relay that invokes search Edge Function
- Integration in `buildPrompt()` — append `RELEVANT MEMORIES:` section with deduplication
- Graceful fallback (empty result) when Edge Functions unavailable
- Setup documentation (`docs/SETUP-SEMANTIC-SEARCH.md`)

## Key Decisions

| Decision | Rationale |
|----------|-----------|
| Adopt upstream intent names | `[REMEMBER:]`/`[GOAL:]`/`[DONE:]` keeps parity with fork source |
| OpenAI embeddings via Edge Functions | Keeps OpenAI key in Supabase secrets, relay never needs it |
| Memory-only semantic search | Thread messages already have recency context; memory search adds most value |
| Supabase RPCs over direct queries | `get_facts()`, `get_active_goals()` — cleaner type filtering at DB level |
| Graceful degradation by default | `getRelevantMemory()` returns `[]` on any error — no user-facing failures |
| RELEVANT MEMORIES deduplication | Filters out memories already shown in facts or goals sections |

## Audit

[Full audit report](v1.3-AUDIT.md) — 15/15 requirements, 5/5 integration points, 5/5 E2E flows, 30/30 live tests passed.
